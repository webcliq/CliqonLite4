<?php function finsert($fp,$str,$length=null){$ret=0;$length=!is_null($length)?(int)$length:strlen($str)+1;fflush($fp);$current=ftell($fp);$temp=tmpfile();while(!feof($fp)){fwrite($temp,fread($fp,4096));}rewind($temp);ftruncate($fp,$current);$ret+=fwrite($fp,$str,$length);while(!feof($temp)){fwrite($fp,fread($temp,4096));}fseek($fp,$current+$ret,SEEK_SET);ftruncate($temp,0);fclose($temp);fflush($fp);return$ret;}function finsertcsv($fp,array$fields,$delimiter=",",$enclosure='"',$escape="\\"){$func=create_function('$a','
									$b=\''.str_replace("'","\'",$enclosure).'\';
									$c=\''.str_replace("'","\'",$escape.($escape=="\\"?$escape:"")).'\';
									return $b . str_replace($b, $c . $b, $a) . $b;
								');$str=implode($delimiter,array_map($func,$fields));return finsert($fp,$str.PHP_EOL);}function fremove($fp,$length){$ret=false;fflush($fp);$current=ftell($fp);fseek($fp,$length,SEEK_CUR);$temp=tmpfile();while(!feof($fp)){fwrite($temp,fread($fp,4096));}rewind($temp);$ret=ftruncate($fp,$current);while(!feof($temp)){fwrite($fp,fread($temp,4096));}fseek($fp,$current,SEEK_SET);ftruncate($temp,0);fclose($temp);fflush($fp);return$ret;}function fremovecsv($fp,$length=0,$delimiter=",",$enclosure='"',$escape="\\"){$current=ftell($fp);version_compare(PHP_VERSION,"5.3",">=")?fgetcsv($fp,$length,$delimiter,$enclosure,$escape):fgetcsv($fp,$length,$delimiter,$enclosure);$now=ftell($fp);fseek($fp,$current,SEEK_SET);return fremove($fp,$now-$current);}function fprepend($fp,$str,$length=null){$ret=0;$length=!is_null($length)?(int)$length:strlen($str)+1;fflush($fp);$current=ftell($fp);rewind($fp);$temp=tmpfile();while(!feof($fp)){fwrite($temp,fread($fp,4096));}rewind($temp);ftruncate($fp,0);$ret+=fwrite($fp,$str,$length);while(!feof($temp)){fwrite($fp,fread($temp,4096));}fseek($fp,$current+$ret,SEEK_SET);ftruncate($temp,0);fclose($temp);fflush($fp);return$ret;}function fchange($fp,$str,$offset,$length,$whence=SEEK_SET){$ret=0;fflush($fp);fseek($fp,$offset,$whence);fseek($fp,$length,SEEK_CUR);$temp=tmpfile();while(!feof($fp)){fwrite($temp,fread($fp,4096));}rewind($temp);ftruncate($fp,$offset);$ret+=fwrite($fp,$str,$length);while(!feof($temp)){fwrite($fp,fread($temp,4096));}fseek($fp,$offset,$whence);fseek($fp,$length,SEEK_CUR);ftruncate($temp,0);fclose($temp);fflush($fp);return$ret;}function fpreg_match($fp,$regex,&$matches=null,$flags=0,$offset=0){return feof($fp)?0:preg_match($regex,fgets($fp),$matches,$flags,$offset);}function fpreg_match_all($fp,$regex,&$matches=null,$flags=0){$pos=ftell($fp);$matched=0;$match=null;$matches=array();$flag=$flags&PREG_OFFSET_CAPTURE;while(!feof($fp)){if(preg_match($regex,fgets($fp),$match,$flag)){++$matched;$matches[]=$match;}}fseek($fp,$pos,SEEK_SET);if($matched){if($flags&PREG_SET_ORDER){$ret=array();$number=count($matches[0]);foreach($matches as$match){for($i=0;$i<$number;++$i){if(!isset($ret[$i])){$ret[$i]=array();}$ret[$i][]=isset($match[$i])?$match[$i]:null;}}$matches=$ret;}}return$matched;}?>