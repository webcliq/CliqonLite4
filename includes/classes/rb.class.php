<?php namespace RedBeanPHP{interface Logger{public function log();}}namespace RedBeanPHP\Logger{use RedBeanPHP\Logger as Logger;use RedBeanPHP\RedException as RedException;use RedBeanPHP\RedException\Security as Security;class RDefault implements Logger{protected$mode=0;protected$logs=array();public function log(){if(func_num_args()<1)return;foreach(func_get_args()as$argument){if(is_array($argument)){$log=print_r($argument,TRUE);if($this->mode===0){echo $log;}else{$this->logs[]=$log;}}else{if($this->mode===0){echo $argument;}else{$this->logs[]=$argument;}}if($this->mode===0)echo"<br>\n";}}public function getLogs(){return$this->logs;}public function clear(){$this->logs=array();return$this;}public function setMode($mode){if($mode!==0&&$mode!==1){throw new RedException('Invalid mode selected for logger, use 1 or 0.');}$this->mode=$mode;return$this;}public function grep($needle){$found=array();foreach($this->logs as$logEntry){if(strpos($logEntry,$needle)!==false)$found[]=$logEntry;}return$found;}}}namespace RedBeanPHP{interface Driver{public function GetAll($sql,$bindings=array());public function GetCol($sql,$bindings=array());public function GetCell($sql,$bindings=array());public function GetAssocRow($sql,$bindings=array());public function GetRow($sql,$bindings=array());public function Execute($sql,$bindings=array());public function GetInsertID();public function Affected_Rows();public function setDebugMode($tf);public function CommitTrans();public function StartTrans();public function FailTrans();}}namespace RedBeanPHP\Driver{use RedBeanPHP\Driver as Driver;use RedBeanPHP\Logger as Logger;use RedBeanPHP\QueryWriter\AQueryWriter as AQueryWriter;use RedBeanPHP\RedException\SQL as SQL;use RedBeanPHP\Logger\RDefault as RDefault;use RedBeanPHP\PDOCompatible as PDOCompatible;class RPDO implements Driver{protected$dsn;protected$debug=FALSE;protected$logger=NULL;protected$pdo;protected$affectedRows;protected$resultArray;protected$connectInfo=array();protected$isConnected=FALSE;protected$flagUseStringOnlyBinding=FALSE;protected$mysqlEncoding='';protected function bindParams($statement,$bindings){foreach($bindings as$key=>&$value){if(is_integer($key)){if(is_null($value)){$statement->bindValue($key+1,NULL,\PDO::PARAM_NULL);}elseif(!$this->flagUseStringOnlyBinding&&AQueryWriter::canBeTreatedAsInt($value)&&$value<2147483648){$statement->bindParam($key+1,$value,\PDO::PARAM_INT);}else{$statement->bindParam($key+1,$value,\PDO::PARAM_STR);}}else{if(is_null($value)){$statement->bindValue($key,NULL,\PDO::PARAM_NULL);}elseif(!$this->flagUseStringOnlyBinding&&AQueryWriter::canBeTreatedAsInt($value)&&$value<2147483648){$statement->bindParam($key,$value,\PDO::PARAM_INT);}else{$statement->bindParam($key,$value,\PDO::PARAM_STR);}}}}protected function runQuery($sql,$bindings,$options=array()){$this->connect();if($this->debug&&$this->logger){$this->logger->log($sql,$bindings);}try{if(strpos('pgsql',$this->dsn)===0){$statement=$this->pdo->prepare($sql,array(\PDO::PGSQL_ATTR_DISABLE_NATIVE_PREPARED_STATEMENT=>TRUE));}else{$statement=$this->pdo->prepare($sql);}$this->bindParams($statement,$bindings);$statement->execute();$this->affectedRows=$statement->rowCount();if($statement->columnCount()){$fetchStyle=(isset($options['fetchStyle']))?$options['fetchStyle']:NULL;$this->resultArray=$statement->fetchAll($fetchStyle);if($this->debug&&$this->logger){$this->logger->log('resultset: '.count($this->resultArray).' rows');}}else{$this->resultArray=array();}}catch(\PDOException $e){$err=$e->getMessage();if($this->debug&&$this->logger)$this->logger->log('An error occurred: '.$err);$exception=new SQL($err,0);$exception->setSQLState($e->getCode());throw $exception;}}protected function setEncoding(){$driver=$this->pdo->getAttribute(\PDO::ATTR_DRIVER_NAME);$version=floatval($this->pdo->getAttribute(\PDO::ATTR_SERVER_VERSION));if($driver==='mysql'){$encoding=($version>=5.5)?'utf8mb4':'utf8';$this->pdo->setAttribute(\PDO::MYSQL_ATTR_INIT_COMMAND,'SET NAMES '.$encoding);$this->pdo->exec(' SET NAMES '.$encoding);$this->mysqlEncoding=$encoding;}}public function getMysqlEncoding(){return$this->mysqlEncoding;}public function __construct($dsn,$user=NULL,$pass=NULL){if(is_object($dsn)){$this->pdo=$dsn;$this->isConnected=TRUE;$this->setEncoding();$this->pdo->setAttribute(\PDO::ATTR_ERRMODE,\PDO::ERRMODE_EXCEPTION);$this->pdo->setAttribute(\PDO::ATTR_DEFAULT_FETCH_MODE,\PDO::FETCH_ASSOC);$this->dsn=$this->getDatabaseType();}else{$this->dsn=$dsn;$this->connectInfo=array('pass'=>$pass,'user'=>$user);}}public function setUseStringOnlyBinding($yesNo){$this->flagUseStringOnlyBinding=(boolean)$yesNo;}public function connect(){if($this->isConnected)return;try{$user=$this->connectInfo['user'];$pass=$this->connectInfo['pass'];$this->pdo=new\PDO($this->dsn,$user,$pass,array(\PDO::ATTR_ERRMODE=>\PDO::ERRMODE_EXCEPTION,\PDO::ATTR_DEFAULT_FETCH_MODE=>\PDO::FETCH_ASSOC,));$this->setEncoding();$this->pdo->setAttribute(\PDO::ATTR_STRINGIFY_FETCHES,TRUE);$this->isConnected=TRUE;}catch(\PDOException $exception){$matches=array();$dbname=(preg_match('/dbname=(\w+)/',$this->dsn,$matches))?$matches[1]:'?';throw new\PDOException('Could not connect to database ('.$dbname.').',$exception->getCode());}}public function GetAll($sql,$bindings=array()){$this->runQuery($sql,$bindings);return$this->resultArray;}public function GetAssocRow($sql,$bindings=array()){$this->runQuery($sql,$bindings,array('fetchStyle'=>\PDO::FETCH_ASSOC));return$this->resultArray;}public function GetCol($sql,$bindings=array()){$rows=$this->GetAll($sql,$bindings);$cols=array();if($rows&&is_array($rows)&&count($rows)>0){foreach($rows as$row){$cols[]=array_shift($row);}}return$cols;}public function GetCell($sql,$bindings=array()){$arr=$this->GetAll($sql,$bindings);$row1=array_shift($arr);$col1=array_shift($row1);return$col1;}public function GetRow($sql,$bindings=array()){$arr=$this->GetAll($sql,$bindings);return array_shift($arr);}public function Execute($sql,$bindings=array()){$this->runQuery($sql,$bindings);return$this->affectedRows;}public function GetInsertID(){$this->connect();return(int)$this->pdo->lastInsertId();}public function Affected_Rows(){$this->connect();return(int)$this->affectedRows;}public function setDebugMode($tf,$logger=NULL){$this->connect();$this->debug=(bool)$tf;if($this->debug and!$logger){$logger=new RDefault();}$this->setLogger($logger);}public function setLogger(Logger $logger){$this->logger=$logger;}public function getLogger(){return$this->logger;}public function StartTrans(){$this->connect();$this->pdo->beginTransaction();}public function CommitTrans(){$this->connect();$this->pdo->commit();}public function FailTrans(){$this->connect();$this->pdo->rollback();}public function getDatabaseType(){$this->connect();return$this->pdo->getAttribute(\PDO::ATTR_DRIVER_NAME);}public function getDatabaseVersion(){$this->connect();return$this->pdo->getAttribute(\PDO::ATTR_CLIENT_VERSION);}public function getPDO(){$this->connect();return$this->pdo;}public function close(){$this->pdo=NULL;$this->isConnected=FALSE;}public function isConnected(){return$this->isConnected&&$this->pdo;}}}namespace RedBeanPHP{use RedBeanPHP\QueryWriter\AQueryWriter as AQueryWriter;use RedBeanPHP\BeanHelper as BeanHelper;use RedBeanPHP\RedException\Security as Security;class OODBBean implements\IteratorAggregate,\ArrayAccess,\Countable{private$flagSkipBeau=FALSE;private$properties=array();private$__info=array();private$beanHelper=NULL;private$fetchType=NULL;private$withSql='';private$withParams=array();private$aliasName=NULL;private$via=NULL;private$noLoad=FALSE;private$all=FALSE;private function getAlias($type){if($this->fetchType){$type=$this->fetchType;$this->fetchType=NULL;}return$type;}private function getSharedList($type,$redbean,$toolbox){$writer=$toolbox->getWriter();if($this->via){$oldName=$writer->getAssocTable(array($this->__info['type'],$type));if($oldName!==$this->via){$writer->renameAssocTable($oldName,$this->via);}$this->via=NULL;}$type=$this->beau($type);$assocManager=$redbean->getAssociationManager();$beans=$assocManager->related($this,$type,$this->withSql,$this->withParams);$this->withSql='';$this->withParams=array();return$beans;}private function getOwnList($type,$redbean){$type=$this->beau($type);if($this->aliasName){$parentField=$this->aliasName;$myFieldLink=$parentField.'_id';$this->__info['sys.alias.'.$type]=$this->aliasName;$this->aliasName=NULL;}else{$parentField=$this->__info['type'];$myFieldLink=$parentField.'_id';}$beans=array();if($this->getID()>0){$firstKey=NULL;if(count($this->withParams)>0){reset($this->withParams);$firstKey=key($this->withParams);}if(!is_numeric($firstKey)||$firstKey===NULL){$bindings=$this->withParams;$bindings[':slot0']=$this->getID();$beans=$redbean->find($type,array()," $myFieldLink = :slot0 ".$this->withSql,$bindings);}else{$bindings=array_merge(array($this->getID()),$this->withParams);$beans=$redbean->find($type,array()," $myFieldLink = ? ".$this->withSql,$bindings);}}$this->withSql='';$this->withParams=array();foreach($beans as$beanFromList){$beanFromList->__info['sys.parentcache.'.$parentField]=$this;}return$beans;}public static function setMetaAll($beans,$property,$value){foreach($beans as$bean){$bean->__info[$property]=$value;}return$beans;}public function initializeForDispense($type,BeanHelper $beanhelper){$this->beanHelper=$beanhelper;$this->__info['type']=$type;$this->__info['sys.id']='id';$this->__info['sys.orig']=array('id'=>0);$this->__info['tainted']=TRUE;$this->properties['id']=0;}public function setBeanHelper(BeanHelper $helper){$this->beanHelper=$helper;}public function getIterator(){return new\ArrayIterator($this->properties);}public function import($array,$selection=FALSE,$notrim=FALSE){if(is_string($selection)){$selection=explode(',',$selection);}if(!$notrim&&is_array($selection)){foreach($selection as$key=>$selected){$selection[$key]=trim($selected);}}foreach($array as$key=>$value){if($key!='__info'){if(!$selection||($selection&&in_array($key,$selection))){if(is_array($value)){if(isset($value['_type'])){$bean=$this->beanHelper->getToolbox()->getRedBean()->dispense($value['_type']);unset($value['_type']);$bean->import($value);$this->$key=$bean;}else{$listBeans=array();foreach($value as$listKey=>$listItem){$bean=$this->beanHelper->getToolbox()->getRedBean()->dispense($listItem['_type']);unset($listItem['_type']);$bean->import($listItem);$list=&$this->$key;$list[$listKey]=$bean;}}}else{$this->$key=$value;}}}}return$this;}public function importRow($row){$this->properties=$row;$this->__info['sys.orig']=$row;return$this;}public function importFrom(OODBBean $sourceBean){$this->__info['tainted']=TRUE;$this->properties=$sourceBean->properties;return$this;}public function inject(OODBBean $otherBean){$myID=$this->properties['id'];$this->import($otherBean->export());$this->id=$myID;return$this;}public function export($meta=FALSE,$parents=FALSE,$onlyMe=FALSE,$filters=array()){$arr=array();if($parents){foreach($this as$key=>$value){if(substr($key,-3)!='_id')continue;$prop=substr($key,0,strlen($key)-3);$this->$prop;}}$hasFilters=is_array($filters)&&count($filters);foreach($this as$key=>$value){if(!$onlyMe&&is_array($value)){$vn=array();foreach($value as$i=>$b){$vn[]=$b->export($meta,FALSE,FALSE,$filters);$value=$vn;}}elseif($value instanceof OODBBean){if($hasFilters){if(!in_array(strtolower($value->getMeta('type')),$filters))continue;}$value=$value->export($meta,$parents,FALSE,$filters);}$arr[$key]=$value;}if($meta){$arr['__info']=$this->__info;}return$arr;}public function __isset($property){$property=$this->beau($property);if(strpos($property,'xown')===0&&ctype_upper(substr($property,4,1))){$property=substr($property,1);}return isset($this->properties[$property]);}public function getID(){return(isset($this->properties['id']))?(string)$this->properties['id']:NULL;}public function __unset($property){$property=$this->beau($property);if(strpos($property,'xown')===0&&ctype_upper(substr($property,4,1))){$property=substr($property,1);}unset($this->properties[$property]);$shadowKey='sys.shadow.'.$property;if(isset($this->__info[$shadowKey]))unset($this->__info[$shadowKey]);$this->withSql='';$this->withParams=array();$this->aliasName=NULL;$this->fetchType=NULL;$this->noLoad=FALSE;$this->all=FALSE;$this->via=NULL;return;}public function with($sql,$bindings=array()){$this->withSql=$sql;$this->withParams=$bindings;return$this;}public function withCondition($sql,$bindings=array()){$this->withSql=' AND '.$sql;$this->withParams=$bindings;return$this;}public function all(){$this->all=TRUE;return$this;}public function noLoad(){$this->noLoad=TRUE;return$this;}public function alias($aliasName){$this->aliasName=$this->beau($aliasName);return$this;}public function getProperties(){return$this->properties;}public function getPropertiesAndType(){return array($this->properties,$this->__info['type']);}public function beau($property){static$beautifulColumns=array();if(ctype_lower($property))return$property;if(strpos($property,'own')===0||strpos($property,'xown')===0||strpos($property,'shared')===0){$property=preg_replace('/List$/','',$property);return$property;}if(!isset($beautifulColumns[$property])){$beautifulColumns[$property]=AQueryWriter::camelsSnake($property);}return$beautifulColumns[$property];}public function getModFlags(){$modFlags='';if($this->aliasName!==NULL)$modFlags.='a';if($this->fetchType!==NULL)$modFlags.='f';if($this->noLoad===TRUE)$modFlags.='n';if($this->all===TRUE)$modFlags.='r';if($this->withSql!=='')$modFlags.='w';return$modFlags;}public function clearModifiers(){$this->withSql='';$this->withParams=array();$this->aliasName=NULL;$this->fetchType=NULL;$this->noLoad=FALSE;$this->all=FALSE;$this->via=NULL;return$this;}public function isListInExclusiveMode($listName){$listName=$this->beau($listName);if(strpos($listName,'xown')===0&&ctype_upper(substr($listName,4,1))){$listName=substr($listName,1);}$listName=lcfirst(substr($listName,3));return(isset($this->__info['sys.exclusive-'.$listName])&&$this->__info['sys.exclusive-'.$listName]);}public function&__get($property){$isEx=FALSE;$isOwn=FALSE;$isShared=FALSE;if(!ctype_lower($property)){$property=$this->beau($property);if(strpos($property,'xown')===0&&ctype_upper(substr($property,4,1))){$property=substr($property,1);$listName=lcfirst(substr($property,3));$isEx=TRUE;$isOwn=TRUE;$this->__info['sys.exclusive-'.$listName]=TRUE;}elseif(strpos($property,'own')===0&&ctype_upper(substr($property,3,1))){$isOwn=TRUE;$listName=lcfirst(substr($property,3));}elseif(strpos($property,'shared')===0&&ctype_upper(substr($property,6,1))){$isShared=TRUE;}}$fieldLink=$property.'_id';$exists=isset($this->properties[$property]);if(!$exists&&!isset($this->$fieldLink)&&(!$isOwn&&!$isShared)){$this->withSql='';$this->withParams=array();$this->aliasName=NULL;$this->fetchType=NULL;$this->noLoad=FALSE;$this->all=FALSE;$this->via=NULL;$NULL=NULL;return$NULL;}$hasAlias=(!is_null($this->aliasName));$differentAlias=($hasAlias&&$isOwn&&isset($this->__info['sys.alias.'.$listName]))?($this->__info['sys.alias.'.$listName]!==$this->aliasName):FALSE;$hasSQL=($this->withSql!==''||$this->via!==NULL);$hasAll=(boolean)($this->all);if($exists&&((!$isOwn&&!$isShared)||(!$hasSQL&&!$differentAlias&&!$hasAll))){$this->withSql='';$this->withParams=array();$this->aliasName=NULL;$this->fetchType=NULL;$this->noLoad=FALSE;$this->all=FALSE;$this->via=NULL;return$this->properties[$property];}list($redbean,,,$toolbox)=$this->beanHelper->getExtractedToolbox();if(isset($this->$fieldLink)){$this->__info['tainted']=TRUE;if(isset($this->__info["sys.parentcache.$property"])){$bean=$this->__info["sys.parentcache.$property"];}else{$type=$this->getAlias($property);$bean=$redbean->load($type,$this->properties[$fieldLink]);}$this->properties[$property]=$bean;$this->withSql='';$this->withParams=array();$this->aliasName=NULL;$this->fetchType=NULL;$this->noLoad=FALSE;$this->all=FALSE;$this->via=NULL;return$this->properties[$property];}if($this->noLoad){$beans=array();}elseif($isOwn){$beans=$this->getOwnList($listName,$redbean);}else{$beans=$this->getSharedList(lcfirst(substr($property,6)),$redbean,$toolbox);}$this->properties[$property]=$beans;$this->__info["sys.shadow.$property"]=$beans;$this->__info['tainted']=TRUE;$this->withSql='';$this->withParams=array();$this->aliasName=NULL;$this->fetchType=NULL;$this->noLoad=FALSE;$this->all=FALSE;$this->via=NULL;return$this->properties[$property];}public function __set($property,$value){$isEx=FALSE;$isOwn=FALSE;$isShared=FALSE;if(!ctype_lower($property)){$property=$this->beau($property);if(strpos($property,'xown')===0&&ctype_upper(substr($property,4,1))){$property=substr($property,1);$listName=lcfirst(substr($property,3));$isEx=TRUE;$isOwn=TRUE;$this->__info['sys.exclusive-'.$listName]=TRUE;}elseif(strpos($property,'own')===0&&ctype_upper(substr($property,3,1))){$isOwn=TRUE;$listName=lcfirst(substr($property,3));}elseif(strpos($property,'shared')===0&&ctype_upper(substr($property,6,1))){$isShared=TRUE;}}$hasAlias=(!is_null($this->aliasName));$differentAlias=($hasAlias&&$isOwn&&isset($this->__info['sys.alias.'.$listName]))?($this->__info['sys.alias.'.$listName]!==$this->aliasName):FALSE;$hasSQL=($this->withSql!==''||$this->via!==NULL);$exists=isset($this->properties[$property]);$fieldLink=$property.'_id';if(($isOwn||$isShared)&&(!$exists||$hasSQL||$differentAlias)){if(!$this->noLoad){list($redbean,,,$toolbox)=$this->beanHelper->getExtractedToolbox();if($isOwn){$beans=$this->getOwnList($listName,$redbean);}else{$beans=$this->getSharedList(lcfirst(substr($property,6)),$redbean,$toolbox);}$this->__info["sys.shadow.$property"]=$beans;}}$this->withSql='';$this->withParams=array();$this->aliasName=NULL;$this->fetchType=NULL;$this->noLoad=FALSE;$this->all=FALSE;$this->via=NULL;$this->__info['tainted']=TRUE;if(array_key_exists($fieldLink,$this->properties)&&!($value instanceof OODBBean)){if(is_null($value)||$value===FALSE){unset($this->properties[$property]);$this->properties[$fieldLink]=NULL;return;}else{throw new RedException('Cannot cast to bean.');}}if($value===FALSE){$value='0';}elseif($value===TRUE){$value='1';}elseif($value instanceof\DateTime){$value=$value->format('Y-m-d H:i:s');}$this->properties[$property]=$value;}public function setProperty($property,$value,$updateShadow=FALSE,$taint=FALSE){$this->properties[$property]=$value;if($updateShadow){$this->__info['sys.shadow.'.$property]=$value;}if($taint){$this->__info['tainted']=TRUE;}}public function getMeta($path,$default=NULL){return(isset($this->__info[$path]))?$this->__info[$path]:$default;}public function setMeta($path,$value){$this->__info[$path]=$value;return$this;}public function copyMetaFrom(OODBBean $bean){$this->__info=$bean->__info;return$this;}public function __call($method,$args){if(!isset($this->__info['model'])){$model=$this->beanHelper->getModelForBean($this);if(!$model){return NULL;}$this->__info['model']=$model;}if(!method_exists($this->__info['model'],$method)){return NULL;}return call_user_func_array(array($this->__info['model'],$method),$args);}public function __toString(){$string=$this->__call('__toString',array());if($string===NULL){return json_encode($this->properties);}else{return$string;}}public function offsetSet($offset,$value){$this->__set($offset,$value);}public function offsetExists($offset){return$this->__isset($offset);}public function offsetUnset($offset){$this->__unset($offset);}public function&offsetGet($offset){return$this->__get($offset);}public function fetchAs($type){$this->fetchType=$type;return$this;}public function poly($field){return$this->fetchAs($this->$field);}public function traverse($property,$function,$maxDepth=NULL){$this->via=NULL;if(strpos($property,'shared')!==FALSE){throw new RedException('Traverse only works with (x)own-lists.');}if(!is_null($maxDepth)){if(!$maxDepth--)return$this;}$oldFetchType=$this->fetchType;$oldAliasName=$this->aliasName;$oldWith=$this->withSql;$oldBindings=$this->withParams;$beans=$this->$property;if($beans===NULL)return$this;if(!is_array($beans))$beans=array($beans);foreach($beans as$bean){$function($bean);$bean->fetchType=$oldFetchType;$bean->aliasName=$oldAliasName;$bean->withSql=$oldWith;$bean->withParams=$oldBindings;$bean->traverse($property,$function,$maxDepth);}return$this;}public function count(){return count($this->properties);}public function isEmpty(){$empty=TRUE;foreach($this->properties as$key=>$value){if($key=='id'){continue;}if(!empty($value)){$empty=FALSE;}}return$empty;}public function setAttr($property,$value){$this->$property=$value;return$this;}public function unsetAll($properties){foreach($properties as$prop){if(isset($this->properties[$prop])){unset($this->properties[$prop]);}}return$this;}public function old($property){$old=$this->getMeta('sys.orig',array());if(array_key_exists($property,$old)){return$old[$property];}return NULL;}public function isTainted(){return$this->getMeta('tainted');}public function hasChanged($property){return(array_key_exists($property,$this->properties))?$this->old($property)!=$this->properties[$property]:FALSE;}public function link($typeOrBean,$qualification=array()){if(is_string($typeOrBean)){$typeOrBean=AQueryWriter::camelsSnake($typeOrBean);$bean=$this->beanHelper->getToolBox()->getRedBean()->dispense($typeOrBean);if(is_string($qualification)){$data=json_decode($qualification,TRUE);}else{$data=$qualification;}foreach($data as$key=>$value){$bean->$key=$value;}}else{$bean=$typeOrBean;}$list='own'.ucfirst($bean->getMeta('type'));array_push($this->$list,$bean);return$bean;}public function fresh(){return$this->beanHelper->getToolbox()->getRedBean()->load($this->getMeta('type'),$this->properties['id']);}public function via($via){$this->via=$via;return$this;}public function countOwn($type){$type=$this->beau($type);if($this->aliasName){$myFieldLink=$this->aliasName.'_id';$this->aliasName=NULL;}else{$myFieldLink=$this->__info['type'].'_id';}$count=0;if($this->getID()!==0){$firstKey=NULL;if(count($this->withParams)>0){reset($this->withParams);$firstKey=key($this->withParams);}if(!is_numeric($firstKey)||$firstKey===NULL){$bindings=$this->withParams;$bindings[':slot0']=$this->getID();$count=$this->beanHelper->getToolbox()->getWriter()->queryRecordCount($type,array()," $myFieldLink = :slot0 ".$this->withSql,$bindings);}else{$bindings=array_merge(array($this->getID()),$this->withParams);$count=$this->beanHelper->getToolbox()->getWriter()->queryRecordCount($type,array()," $myFieldLink = ? ".$this->withSql,$bindings);}}$this->clearModifiers();return(int)$count;}public function countShared($type){$toolbox=$this->beanHelper->getToolbox();$redbean=$toolbox->getRedBean();$writer=$toolbox->getWriter();if($this->via){$oldName=$writer->getAssocTable(array($this->__info['type'],$type));if($oldName!==$this->via){$writer->renameAssocTable($oldName,$this->via);$this->via=NULL;}}$type=$this->beau($type);$count=0;if($this->getID()>0){$count=$redbean->getAssociationManager()->relatedCount($this,$type,$this->withSql,$this->withParams,TRUE);}$this->clearModifiers();return(integer)$count;}public function equals(OODBBean $bean){return(bool)(((string)$this->properties['id']===(string)$bean->properties['id'])&&((string)$this->__info['type']===(string)$bean->__info['type']));}}}namespace RedBeanPHP{use RedBeanPHP\Observer as Observer;abstract class Observable{private$observers=array();public function addEventListener($eventname,Observer $observer){if(!isset($this->observers[$eventname])){$this->observers[$eventname]=array();}foreach($this->observers[$eventname]as$o){if($o==$observer){return;}}$this->observers[$eventname][]=$observer;}public function signal($eventname,$info){if(!isset($this->observers[$eventname])){$this->observers[$eventname]=array();}foreach($this->observers[$eventname]as$observer){$observer->onEvent($eventname,$info);}}}}namespace RedBeanPHP{interface Observer{public function onEvent($eventname,$bean);}}namespace RedBeanPHP{interface Adapter{public function getSQL();public function exec($sql,$bindings=array(),$noevent=FALSE);public function get($sql,$bindings=array());public function getRow($sql,$bindings=array());public function getCol($sql,$bindings=array());public function getCell($sql,$bindings=array());public function getAssoc($sql,$bindings=array());public function getAssocRow($sql,$bindings=array());public function getInsertID();public function getAffectedRows();public function getDatabase();public function startTransaction();public function commit();public function rollback();public function close();}}namespace RedBeanPHP\Adapter{use RedBeanPHP\Observable as Observable;use RedBeanPHP\Adapter as Adapter;use RedBeanPHP\Driver as Driver;class DBAdapter extends Observable implements Adapter{private$db=NULL;private$sql='';public function __construct($database){$this->db=$database;}public function getSQL(){return$this->sql;}public function exec($sql,$bindings=array(),$noevent=FALSE){if(!$noevent){$this->sql=$sql;$this->signal('sql_exec',$this);}return$this->db->Execute($sql,$bindings);}public function get($sql,$bindings=array()){$this->sql=$sql;$this->signal('sql_exec',$this);return$this->db->GetAll($sql,$bindings);}public function getRow($sql,$bindings=array()){$this->sql=$sql;$this->signal('sql_exec',$this);return$this->db->GetRow($sql,$bindings);}public function getCol($sql,$bindings=array()){$this->sql=$sql;$this->signal('sql_exec',$this);return$this->db->GetCol($sql,$bindings);}public function getAssoc($sql,$bindings=array()){$this->sql=$sql;$this->signal('sql_exec',$this);$rows=$this->db->GetAll($sql,$bindings);$assoc=array();if(!$rows){return$assoc;}foreach($rows as$row){if(empty($row))continue;if(count($row)>1){$key=array_shift($row);$value=array_shift($row);}else{$key=array_shift($row);$value=$key;}$assoc[$key]=$value;}return$assoc;}public function getAssocRow($sql,$bindings=array()){$this->sql=$sql;$this->signal('sql_exec',$this);return$this->db->GetAssocRow($sql,$bindings);}public function getCell($sql,$bindings=array(),$noSignal=NULL){$this->sql=$sql;if(!$noSignal)$this->signal('sql_exec',$this);$arr=$this->db->getCol($sql,$bindings);if($arr&&is_array($arr)&&isset($arr[0])){return($arr[0]);}return NULL;}public function getInsertID(){return$this->db->getInsertID();}public function getAffectedRows(){return$this->db->Affected_Rows();}public function getDatabase(){return$this->db;}public function startTransaction(){$this->db->StartTrans();}public function commit(){$this->db->CommitTrans();}public function rollback(){$this->db->FailTrans();}public function close(){$this->db->close();}}}namespace RedBeanPHP{interface QueryWriter{const C_SQLSTATE_NO_SUCH_TABLE=1;const C_SQLSTATE_NO_SUCH_COLUMN=2;const C_SQLSTATE_INTEGRITY_CONSTRAINT_VIOLATION=3;const C_DATATYPE_RANGE_SPECIAL=80;const C_DATATYPE_RANGE_SPECIFIED=99;const C_GLUE_WHERE=1;const C_GLUE_AND=2;public function glueSQLCondition($sql,$glue=NULL);public function getTables();public function createTable($type);public function getColumns($type);public function scanType($value,$alsoScanSpecialForTypes=FALSE);public function addColumn($type,$column,$field);public function code($typedescription,$includeSpecials=FALSE);public function widenColumn($type,$column,$datatype);public function queryRecord($type,$conditions=array(),$addSql=NULL,$bindings=array());public function queryRecordRelated($sourceType,$destType,$linkID,$addSql='',$bindings=array());public function queryRecordLink($sourceType,$destType,$sourceID,$destID);public function queryRecordCount($type,$conditions=array(),$addSql=NULL,$bindings=array());public function queryRecordCountRelated($sourceType,$targetType,$linkID,$addSQL='',$bindings=array());public function updateRecord($type,$updatevalues,$id=NULL);public function deleteRecord($type,$conditions=array(),$addSql='',$bindings=array());public function deleteRelations($sourceType,$destType,$sourceID);public function addUniqueIndex($type,$columns);public function sqlStateIn($state,$list);public function wipe($type);public function addConstraintForTypes($sourceType,$destType);public function addFK($type,$targetType,$field,$targetField,$isDep=false);public function addIndex($type,$name,$column);public function esc($databaseStructure,$dontQuote=FALSE);public function wipeAll();public function renameAssocTable($from,$to=NULL);public function getAssocTable($types);}}namespace RedBeanPHP\QueryWriter{use RedBeanPHP\Adapter\DBAdapter as DBAdapter;use RedBeanPHP\RedException as RedException;use RedBeanPHP\QueryWriter as QueryWriter;use RedBeanPHP\OODBBean as OODBBean;abstract class AQueryWriter{protected$adapter;protected$defaultValue='NULL';protected$quoteCharacter='';protected$flagUseCache=TRUE;protected$cache=array();public static$renames=array();public$typeno_sqltype=array();public static function clearRenames(){self::$renames=array();}protected function getParametersForInClause(&$valueList,$otherBindings,$offset=0){if(is_array($otherBindings)&&count($otherBindings)>0){reset($otherBindings);$key=key($otherBindings);if(!is_numeric($key)){$filler=array();$newList=(!$offset)?array():$valueList;$counter=$offset;foreach($valueList as$value){$slot=':slot'.($counter++);$filler[]=$slot;$newList[$slot]=$value;}$valueList=$newList;return implode(',',$filler);}}return implode(',',array_fill(0,count($valueList),'?'));}private function getCacheKey($keyValues){return json_encode($keyValues);}private function getCached($cacheTag,$key){$sql=$this->adapter->getSQL();if($this->updateCache()){if(isset($this->cache[$cacheTag][$key])){return$this->cache[$cacheTag][$key];}}return NULL;}private function updateCache(){$sql=$this->adapter->getSQL();if(strpos($sql,'-- keep-cache')!==strlen($sql)-13){$this->cache=array();return FALSE;}return TRUE;}private function putResultInCache($cacheTag,$key,$values){$this->cache[$cacheTag]=array($key=>$values);}private function makeSQLFromConditions($conditions,&$bindings,$addSql=''){reset($bindings);$firstKey=key($bindings);$paramTypeIsNum=(is_numeric($firstKey));$counter=0;$sqlConditions=array();foreach($conditions as$column=>$values){if(!count($values))continue;$sql=$this->esc($column);$sql.=' IN ( ';if(!is_array($values))$values=array($values);if(ctype_digit(implode('',$values))){$sql.=implode(',',$values).' ) ';$sqlConditions[]=$sql;}else{if($paramTypeIsNum){$sql.=implode(',',array_fill(0,count($values),'?')).' ) ';array_unshift($sqlConditions,$sql);foreach($values as$k=>$v){$values[$k]=strval($v);array_unshift($bindings,$v);}}else{$slots=array();foreach($values as$k=>$v){$slot=':slot'.$counter++;$slots[]=$slot;$bindings[$slot]=strval($v);}$sql.=implode(',',$slots).' ) ';$sqlConditions[]=$sql;}}}$sql='';if(is_array($sqlConditions)&&count($sqlConditions)>0){$sql=implode(' AND ',$sqlConditions);$sql=" WHERE ( $sql ) ";if($addSql)$sql.=$addSql;}elseif($addSql){$sql=$addSql;}return$sql;}private function getRelationalTablesAndColumns($sourceType,$destType,$noQuote=FALSE){$linkTable=$this->esc($this->getAssocTable(array($sourceType,$destType)),$noQuote);$sourceCol=$this->esc($sourceType.'_id',$noQuote);if($sourceType===$destType){$destCol=$this->esc($destType.'2_id',$noQuote);}else{$destCol=$this->esc($destType.'_id',$noQuote);}$sourceTable=$this->esc($sourceType,$noQuote);$destTable=$this->esc($destType,$noQuote);return array($sourceTable,$destTable,$linkTable,$sourceCol,$destCol);}protected function getInsertSuffix($table){return'';}protected function startsWithZeros($value){$value=strval($value);if(strlen($value)>1&&strpos($value,'0')===0&&strpos($value,'0.')!==0){return TRUE;}else{return FALSE;}}protected function insertRecord($type,$insertcolumns,$insertvalues){$default=$this->defaultValue;$suffix=$this->getInsertSuffix($type);$table=$this->esc($type);if(count($insertvalues)>0&&is_array($insertvalues[0])&&count($insertvalues[0])>0){foreach($insertcolumns as$k=>$v){$insertcolumns[$k]=$this->esc($v);}$insertSQL="INSERT INTO $table ( id, ".implode(',',$insertcolumns)." ) VALUES
			( $default, ".implode(',',array_fill(0,count($insertcolumns),' ? '))." ) $suffix";$ids=array();foreach($insertvalues as$i=>$insertvalue){$ids[]=$this->adapter->getCell($insertSQL,$insertvalue,$i);}$result=count($ids)===1?array_pop($ids):$ids;}else{$result=$this->adapter->getCell("INSERT INTO $table (id) VALUES($default) $suffix");}if($suffix)return$result;$last_id=$this->adapter->getInsertID();return$last_id;}protected function check($struct){if(!preg_match('/^[a-zA-Z0-9_]+$/',$struct)){throw new RedException('Identifier does not conform to RedBeanPHP security policies.');}return$struct;}public static function canBeTreatedAsInt($value){return(bool)(ctype_digit(strval($value))&&strval($value)===strval(intval($value)));}public static function getAssocTableFormat($types){sort($types);$assoc=implode('_',$types);return(isset(self::$renames[$assoc]))?self::$renames[$assoc]:$assoc;}public static function renameAssociation($from,$to=NULL){if(is_array($from)){foreach($from as$key=>$value)self::$renames[$key]=$value;return;}self::$renames[$from]=$to;}public static function camelsSnake($camel){return strtolower(preg_replace('/(?<=[a-z])([A-Z])|([A-Z])(?=[a-z])/','_$1$2',$camel));}public function tableExists($table){$tables=$this->getTables();return in_array($table,$tables);}public function glueSQLCondition($sql,$glue=NULL){static$snippetCache=array();if(trim($sql)===''){return$sql;}$key=$glue.'|'.$sql;if(isset($snippetCache[$key])){return$snippetCache[$key];}$lsql=ltrim($sql);if(preg_match('/^(INNER|LEFT|RIGHT|JOIN|AND|OR|WHERE|ORDER|GROUP|HAVING|LIMIT|OFFSET)\s+/i',$lsql)){if($glue===QueryWriter::C_GLUE_WHERE&&stripos($lsql,'AND')===0){$snippetCache[$key]=' WHERE '.substr($lsql,3);}else{$snippetCache[$key]=$sql;}}else{$snippetCache[$key]=(($glue===QueryWriter::C_GLUE_AND)?' AND ':' WHERE ').$sql;}return$snippetCache[$key];}public function esc($dbStructure,$dontQuote=FALSE){$this->check($dbStructure);return($dontQuote)?$dbStructure:$this->quoteCharacter.$dbStructure.$this->quoteCharacter;}public function addColumn($type,$column,$field){$table=$type;$type=$field;$table=$this->esc($table);$column=$this->esc($column);$type=(isset($this->typeno_sqltype[$type]))?$this->typeno_sqltype[$type]:'';$this->adapter->exec("ALTER TABLE $table ADD $column $type ");}public function updateRecord($type,$updatevalues,$id=NULL){$table=$type;if(!$id){$insertcolumns=$insertvalues=array();foreach($updatevalues as$pair){$insertcolumns[]=$pair['property'];$insertvalues[]=$pair['value'];}return(string)$this->insertRecord($table,$insertcolumns,array($insertvalues));}if($id&&!count($updatevalues)){return$id;}$table=$this->esc($table);$sql="UPDATE $table SET ";$p=$v=array();foreach($updatevalues as$uv){$p[]=" {$this->esc($uv["property"])} = ? ";$v[]=$uv['value'];}$sql.=implode(',',$p).' WHERE id = ? ';$v[]=$id;$this->adapter->exec($sql,$v);return$id;}public function queryRecord($type,$conditions=array(),$addSql=NULL,$bindings=array()){$addSql=$this->glueSQLCondition($addSql,(count($conditions)>0)?QueryWriter::C_GLUE_AND:NULL);$key=NULL;if($this->flagUseCache){$key=$this->getCacheKey(array($conditions,$addSql,$bindings,'select'));if($cached=$this->getCached($type,$key)){return$cached;}}$table=$this->esc($type);$sql=$this->makeSQLFromConditions($conditions,$bindings,$addSql);$sql="SELECT * FROM {$table} {$sql} -- keep-cache";$rows=$this->adapter->get($sql,$bindings);if($this->flagUseCache&&$key){$this->putResultInCache($type,$key,$rows);}return$rows;}public function queryRecordRelated($sourceType,$destType,$linkIDs,$addSql='',$bindings=array()){$addSql=$this->glueSQLCondition($addSql,QueryWriter::C_GLUE_WHERE);list($sourceTable,$destTable,$linkTable,$sourceCol,$destCol)=$this->getRelationalTablesAndColumns($sourceType,$destType);$key=$this->getCacheKey(array($sourceType,$destType,implode(',',$linkIDs),$addSql,$bindings));if($this->flagUseCache&&$cached=$this->getCached($destType,$key)){return$cached;}$inClause=$this->getParametersForInClause($linkIDs,$bindings);if($sourceType===$destType){$inClause2=$this->getParametersForInClause($linkIDs,$bindings,count($bindings));$sql="
			SELECT
				{$destTable}.*,
				COALESCE(
				NULLIF({$linkTable}.{$sourceCol}, {$destTable}.id),
				NULLIF({$linkTable}.{$destCol}, {$destTable}.id)) AS linked_by
			FROM {$linkTable}
			INNER JOIN {$destTable} ON
			( {$destTable}.id = {$linkTable}.{$destCol} AND {$linkTable}.{$sourceCol} IN ($inClause) ) OR
			( {$destTable}.id = {$linkTable}.{$sourceCol} AND {$linkTable}.{$destCol} IN ($inClause2) )
			{$addSql}
			-- keep-cache";$linkIDs=array_merge($linkIDs,$linkIDs);}else{$sql="
			SELECT
				{$destTable}.*,
				{$linkTable}.{$sourceCol} AS linked_by
			FROM {$linkTable}
			INNER JOIN {$destTable} ON
			( {$destTable}.id = {$linkTable}.{$destCol} AND {$linkTable}.{$sourceCol} IN ($inClause) )
			{$addSql}
			-- keep-cache";}$bindings=array_merge($linkIDs,$bindings);$rows=$this->adapter->get($sql,$bindings);$this->putResultInCache($destType,$key,$rows);return$rows;}public function queryRecordLink($sourceType,$destType,$sourceID,$destID){list($sourceTable,$destTable,$linkTable,$sourceCol,$destCol)=$this->getRelationalTablesAndColumns($sourceType,$destType);$key=$this->getCacheKey(array($sourceType,$destType,$sourceID,$destID));if($this->flagUseCache&&$cached=$this->getCached($linkTable,$key)){return$cached;}if($sourceTable===$destTable){$sql="SELECT {$linkTable}.* FROM {$linkTable}
				WHERE ( {$sourceCol} = ? AND {$destCol} = ? ) OR
				 ( {$destCol} = ? AND {$sourceCol} = ? ) -- keep-cache";$row=$this->adapter->getRow($sql,array($sourceID,$destID,$sourceID,$destID));}else{$sql="SELECT {$linkTable}.* FROM {$linkTable}
				WHERE {$sourceCol} = ? AND {$destCol} = ? -- keep-cache";$row=$this->adapter->getRow($sql,array($sourceID,$destID));}$this->putResultInCache($linkTable,$key,$row);return$row;}public function queryRecordCount($type,$conditions=array(),$addSql=NULL,$bindings=array()){$addSql=$this->glueSQLCondition($addSql);$table=$this->esc($type);$this->updateCache();$sql=$this->makeSQLFromConditions($conditions,$bindings,$addSql);$sql="SELECT COUNT(*) FROM {$table} {$sql} -- keep-cache";return(int)$this->adapter->getCell($sql,$bindings);}public function queryRecordCountRelated($sourceType,$destType,$linkID,$addSql='',$bindings=array()){list($sourceTable,$destTable,$linkTable,$sourceCol,$destCol)=$this->getRelationalTablesAndColumns($sourceType,$destType);$this->updateCache();if($sourceType===$destType){$sql="
			SELECT COUNT(*) FROM {$linkTable}
			INNER JOIN {$destTable} ON
			( {$destTable}.id = {$linkTable}.{$destCol} AND {$linkTable}.{$sourceCol} = ? ) OR
			( {$destTable}.id = {$linkTable}.{$sourceCol} AND {$linkTable}.{$destCol} = ? )
			{$addSql}
			-- keep-cache";$bindings=array_merge(array($linkID,$linkID),$bindings);}else{$sql="
			SELECT COUNT(*) FROM {$linkTable}
			INNER JOIN {$destTable} ON
			( {$destTable}.id = {$linkTable}.{$destCol} AND {$linkTable}.{$sourceCol} = ? )
			{$addSql}
			-- keep-cache";$bindings=array_merge(array($linkID),$bindings);}return(int)$this->adapter->getCell($sql,$bindings);}public function deleteRecord($type,$conditions=array(),$addSql=NULL,$bindings=array()){$addSql=$this->glueSQLCondition($addSql);$table=$this->esc($type);$sql=$this->makeSQLFromConditions($conditions,$bindings,$addSql);$sql="DELETE FROM {$table} {$sql}";$this->adapter->exec($sql,$bindings);}public function deleteRelations($sourceType,$destType,$sourceID){list($sourceTable,$destTable,$linkTable,$sourceCol,$destCol)=$this->getRelationalTablesAndColumns($sourceType,$destType);if($sourceTable===$destTable){$sql="DELETE FROM {$linkTable}
				WHERE ( {$sourceCol} = ? ) OR
				( {$destCol} = ?  )
			";$this->adapter->exec($sql,array($sourceID,$sourceID));}else{$sql="DELETE FROM {$linkTable}
				WHERE {$sourceCol} = ? ";$this->adapter->exec($sql,array($sourceID));}}public function widenColumn($type,$column,$datatype){if(!isset($this->typeno_sqltype[$datatype]))return;$table=$type;$type=$datatype;$table=$this->esc($table);$column=$this->esc($column);$newtype=$this->typeno_sqltype[$type];$this->adapter->exec("ALTER TABLE $table CHANGE $column $column $newtype ");}public function wipe($type){$table=$this->esc($type);$this->adapter->exec("TRUNCATE $table ");}public function renameAssocTable($from,$to=NULL){self::renameAssociation($from,$to);}public function getAssocTable($types){return self::getAssocTableFormat($types);}public function addConstraintForTypes($sourceType,$destType){list($sourceTable,$destTable,$linkTable,$sourceCol,$destCol)=$this->getRelationalTablesAndColumns($sourceType,$destType,TRUE);return$this->constrain($linkTable,$sourceTable,$destTable,$sourceCol,$destCol);}public function setUseCache($yesNo){$this->flushCache();$this->flagUseCache=(bool)$yesNo;}public function flushCache(){$this->cache=array();}public function safeColumn($column,$noQuotes=FALSE){return$this->esc($column,$noQuotes);}public function safeTable($table,$noQuotes=FALSE){return$this->esc($table,$noQuotes);}}}namespace RedBeanPHP\QueryWriter{use RedBeanPHP\QueryWriter\AQueryWriter as AQueryWriter;use RedBeanPHP\QueryWriter as QueryWriter;use RedBeanPHP\Adapter\DBAdapter as DBAdapter;use RedBeanPHP\Adapter as Adapter;class MySQL extends AQueryWriter implements QueryWriter{const C_DATATYPE_BOOL=0;const C_DATATYPE_UINT32=2;const C_DATATYPE_DOUBLE=3;const C_DATATYPE_TEXT8=4;const C_DATATYPE_TEXT16=5;const C_DATATYPE_TEXT32=6;const C_DATATYPE_SPECIAL_DATE=80;const C_DATATYPE_SPECIAL_DATETIME=81;const C_DATATYPE_SPECIAL_POINT=90;const C_DATATYPE_SPECIFIED=99;protected$adapter;protected$quoteCharacter='`';protected function constrain($table,$table1,$table2,$property1,$property2){try{$db=$this->adapter->getCell('SELECT database()');$fks=$this->adapter->getCell("SELECT count(*)
				FROM information_schema.KEY_COLUMN_USAGE
				WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ? AND
				CONSTRAINT_NAME <>'PRIMARY' AND REFERENCED_TABLE_NAME IS NOT NULL",array($db,$table));if($fks>0){return FALSE;}$columns=$this->getColumns($table);if($this->code($columns[$property1])!==MySQL::C_DATATYPE_UINT32){$this->widenColumn($table,$property1,MySQL::C_DATATYPE_UINT32);}if($this->code($columns[$property2])!==MySQL::C_DATATYPE_UINT32){$this->widenColumn($table,$property2,MySQL::C_DATATYPE_UINT32);}$sql="
				ALTER TABLE ".$this->esc($table)."
				ADD FOREIGN KEY($property1) references `$table1`(id) ON DELETE CASCADE ON UPDATE CASCADE;
			";$this->adapter->exec($sql);$sql="
				ALTER TABLE ".$this->esc($table)."
				ADD FOREIGN KEY($property2) references `$table2`(id) ON DELETE CASCADE ON UPDATE CASCADE
			";$this->adapter->exec($sql);return TRUE;}catch(\Exception $e){return FALSE;}}public function __construct(Adapter $adapter){$this->typeno_sqltype=array(MySQL::C_DATATYPE_BOOL=>' TINYINT(1) UNSIGNED ',MySQL::C_DATATYPE_UINT32=>' INT(11) UNSIGNED ',MySQL::C_DATATYPE_DOUBLE=>' DOUBLE ',MySQL::C_DATATYPE_TEXT8=>' VARCHAR(255) ',MySQL::C_DATATYPE_TEXT16=>' TEXT ',MySQL::C_DATATYPE_TEXT32=>' LONGTEXT ',MySQL::C_DATATYPE_SPECIAL_DATE=>' DATE ',MySQL::C_DATATYPE_SPECIAL_DATETIME=>' DATETIME ',MySQL::C_DATATYPE_SPECIAL_POINT=>' POINT ',);$this->sqltype_typeno=array();foreach($this->typeno_sqltype as$k=>$v){$this->sqltype_typeno[trim(strtolower($v))]=$k;}$this->adapter=$adapter;$this->encoding=$this->adapter->getDatabase()->getMysqlEncoding();}public function getTypeForID(){return self::C_DATATYPE_UINT32;}public function getTables(){return$this->adapter->getCol('show tables');}public function createTable($table){$table=$this->esc($table);$encoding=$this->adapter->getDatabase()->getMysqlEncoding();$sql="CREATE TABLE $table (id INT( 11 ) UNSIGNED NOT NULL AUTO_INCREMENT, PRIMARY KEY ( id )) ENGINE = InnoDB DEFAULT CHARSET={$encoding} COLLATE={$encoding}_unicode_ci ";$this->adapter->exec($sql);}public function getColumns($table){$columnsRaw=$this->adapter->get("DESCRIBE ".$this->esc($table));$columns=array();foreach($columnsRaw as$r){$columns[$r['Field']]=$r['Type'];}return$columns;}public function scanType($value,$flagSpecial=FALSE){$this->svalue=$value;if(is_null($value))return MySQL::C_DATATYPE_BOOL;if($flagSpecial){if(preg_match('/^\d{4}\-\d\d-\d\d$/',$value)){return MySQL::C_DATATYPE_SPECIAL_DATE;}if(preg_match('/^\d{4}\-\d\d-\d\d\s\d\d:\d\d:\d\d$/',$value)){return MySQL::C_DATATYPE_SPECIAL_DATETIME;}}$value=strval($value);if(!$this->startsWithZeros($value)){if($value===TRUE||$value===FALSE||$value==='1'||$value===''||$value==='0'){return MySQL::C_DATATYPE_BOOL;}if(is_numeric($value)&&(floor($value)==$value)&&$value>=0&&$value<=4294967295){return MySQL::C_DATATYPE_UINT32;}if(is_numeric($value)){return MySQL::C_DATATYPE_DOUBLE;}}if(mb_strlen($value,'UTF-8')<=255){return MySQL::C_DATATYPE_TEXT8;}if(mb_strlen($value,'UTF-8')<=65535){return MySQL::C_DATATYPE_TEXT16;}return MySQL::C_DATATYPE_TEXT32;}public function code($typedescription,$includeSpecials=FALSE){if(isset($this->sqltype_typeno[$typedescription])){$r=$this->sqltype_typeno[$typedescription];}else{$r=self::C_DATATYPE_SPECIFIED;}if($includeSpecials){return$r;}if($r>=QueryWriter::C_DATATYPE_RANGE_SPECIAL){return self::C_DATATYPE_SPECIFIED;}return$r;}public function addUniqueIndex($table,$columns){$table=$this->esc($table);sort($columns);foreach($columns as$k=>$v){$columns[$k]=$this->esc($v);}$r=$this->adapter->get("SHOW INDEX FROM $table");$name='UQ_'.sha1(implode(',',$columns));if($r){foreach($r as$i){if($i['Key_name']==$name){return;}}}try{$sql="ALTER TABLE $table
						 ADD UNIQUE INDEX $name (".implode(',',$columns).")";}catch(\Exception $e){}$this->adapter->exec($sql);}public function addIndex($type,$name,$column){$table=$type;$table=$this->esc($table);$name=preg_replace('/\W/','',$name);$column=$this->esc($column);try{foreach($this->adapter->get("SHOW INDEX FROM $table ")as$ind)if($ind['Key_name']===$name)return;$this->adapter->exec("CREATE INDEX $name ON $table ($column) ");}catch(\Exception $e){}}public function addFK($type,$targetType,$field,$targetField,$isDependent=FALSE){$db=$this->adapter->getCell('SELECT DATABASE()');$cfks=$this->adapter->getCell('
			SELECT CONSTRAINT_NAME
				FROM information_schema.KEY_COLUMN_USAGE
			WHERE 
				TABLE_SCHEMA = ? 
				AND TABLE_NAME = ? 
				AND COLUMN_NAME = ? AND
				CONSTRAINT_NAME != \'PRIMARY\'
				AND REFERENCED_TABLE_NAME IS NOT NULL
		',array($db,$type,$field));if($cfks)return;try{$fkName='fk_'.($type.'_'.$field);$cName='c_'.$fkName;$this->adapter->exec("
				ALTER TABLE  {$this->esc($type)}
				ADD CONSTRAINT $cName 
				FOREIGN KEY $fkName ( {$this->esc($field)} ) REFERENCES {$this->esc($targetType)} (
				{$this->esc($targetField)}) ON DELETE ".($isDependent?'CASCADE':'SET NULL').' ON UPDATE '.($isDependent?'CASCADE':'SET NULL').';');}catch(\Exception $e){}}public function sqlStateIn($state,$list){$stateMap=array('42S02'=>QueryWriter::C_SQLSTATE_NO_SUCH_TABLE,'42S22'=>QueryWriter::C_SQLSTATE_NO_SUCH_COLUMN,'23000'=>QueryWriter::C_SQLSTATE_INTEGRITY_CONSTRAINT_VIOLATION);return in_array((isset($stateMap[$state])?$stateMap[$state]:'0'),$list);}public function wipeAll(){$this->adapter->exec('SET FOREIGN_KEY_CHECKS = 0;');foreach($this->getTables()as$t){try{$this->adapter->exec("DROP TABLE IF EXISTS `$t`");}catch(\Exception $e){}try{$this->adapter->exec("DROP VIEW IF EXISTS `$t`");}catch(\Exception $e){}}$this->adapter->exec('SET FOREIGN_KEY_CHECKS = 1;');}}}namespace RedBeanPHP\QueryWriter{use RedBeanPHP\QueryWriter\AQueryWriter as AQueryWriter;use RedBeanPHP\QueryWriter as QueryWriter;use RedBeanPHP\Adapter\DBAdapter as DBAdapter;use RedBeanPHP\Adapter as Adapter;class SQLiteT extends AQueryWriter implements QueryWriter{protected$adapter;protected$quoteCharacter='`';const C_DATATYPE_INTEGER=0;const C_DATATYPE_NUMERIC=1;const C_DATATYPE_TEXT=2;const C_DATATYPE_SPECIFIED=99;protected function getTable($type){$tableName=$this->esc($type,TRUE);$columns=$this->getColumns($type);$indexes=$this->getIndexes($type);$keys=$this->getKeys($type);$table=array('columns'=>$columns,'indexes'=>$indexes,'keys'=>$keys,'name'=>$tableName);$this->tableArchive[$tableName]=$table;return$table;}protected function putTable($tableMap){$table=$tableMap['name'];$q=array();$q[]="DROP TABLE IF EXISTS tmp_backup;";$oldColumnNames=array_keys($this->getColumns($table));foreach($oldColumnNames as$k=>$v)$oldColumnNames[$k]="`$v`";$q[]="CREATE TEMPORARY TABLE tmp_backup(".implode(",",$oldColumnNames).");";$q[]="INSERT INTO tmp_backup SELECT * FROM `$table`;";$q[]="PRAGMA foreign_keys = 0 ";$q[]="DROP TABLE `$table`;";$newTableDefStr='';foreach($tableMap['columns']as$column=>$type){if($column!='id'){$newTableDefStr.=",`$column` $type";}}$fkDef='';foreach($tableMap['keys']as$key){$fkDef.=", FOREIGN KEY(`{$key['from']}`)
						 REFERENCES `{$key['table']}`(`{$key['to']}`)
						 ON DELETE {$key['on_delete']} ON UPDATE {$key['on_update']}";}$q[]="CREATE TABLE `$table` ( `id` INTEGER PRIMARY KEY AUTOINCREMENT  $newTableDefStr  $fkDef );";foreach($tableMap['indexes']as$name=>$index){if(strpos($name,'UQ_')===0){$cols=explode('__',substr($name,strlen('UQ_'.$table)));foreach($cols as$k=>$v)$cols[$k]="`$v`";$q[]="CREATE UNIQUE INDEX $name ON `$table` (".implode(',',$cols).")";}else $q[]="CREATE INDEX $name ON `$table` ({$index['name']}) ";}$q[]="INSERT INTO `$table` SELECT * FROM tmp_backup;";$q[]="DROP TABLE tmp_backup;";$q[]="PRAGMA foreign_keys = 1 ";foreach($q as$sq)$this->adapter->exec($sq);}protected function getIndexes($type){$table=$this->esc($type,TRUE);$indexes=$this->adapter->get("PRAGMA index_list('$table')");$indexInfoList=array();foreach($indexes as$i){$indexInfoList[$i['name']]=$this->adapter->getRow("PRAGMA index_info('{$i['name']}') ");$indexInfoList[$i['name']]['unique']=$i['unique'];}return$indexInfoList;}protected function getKeys($type){$table=$this->esc($type,TRUE);$keys=$this->adapter->get("PRAGMA foreign_key_list('$table')");$keyInfoList=array();foreach($keys as$k){$keyInfoList['from_'.$k['from'].'_to_table_'.$k['table'].'_col_'.$k['to']]=$k;}return$keyInfoList;}protected function buildFK($type,$targetType,$field,$targetField,$constraint=FALSE){$consSQL=($constraint?'CASCADE':'SET NULL');$t=$this->getTable($type);$label='from_'.$field.'_to_table_'.$targetType.'_col_'.$targetField;foreach($t['keys']as$key){if($key['from']===$field)return FALSE;}$t['keys'][$label]=array('table'=>$targetType,'from'=>$field,'to'=>$targetField,'on_update'=>$consSQL,'on_delete'=>$consSQL);$this->putTable($t);return TRUE;}protected function constrain($table,$table1,$table2,$property1,$property2){$firstState=$this->buildFK($table,$table1,$property1,'id',TRUE);$secondState=$this->buildFK($table,$table2,$property2,'id',TRUE);return($firstState&&$secondState);}public function __construct(Adapter $adapter){$this->typeno_sqltype=array(SQLiteT::C_DATATYPE_INTEGER=>'INTEGER',SQLiteT::C_DATATYPE_NUMERIC=>'NUMERIC',SQLiteT::C_DATATYPE_TEXT=>'TEXT',);$this->sqltype_typeno=array();foreach($this->typeno_sqltype as$k=>$v){$this->sqltype_typeno[$v]=$k;}$this->adapter=$adapter;}public function getTypeForID(){return self::C_DATATYPE_INTEGER;}public function scanType($value,$flagSpecial=FALSE){$this->svalue=$value;if($value===FALSE)return self::C_DATATYPE_INTEGER;if($value===NULL)return self::C_DATATYPE_INTEGER;if($this->startsWithZeros($value))return self::C_DATATYPE_TEXT;if(is_numeric($value)&&(intval($value)==$value)&&$value<2147483648)return self::C_DATATYPE_INTEGER;if((is_numeric($value)&&$value<2147483648)||preg_match('/\d{4}\-\d\d\-\d\d/',$value)||preg_match('/\d{4}\-\d\d\-\d\d\s\d\d:\d\d:\d\d/',$value)){return self::C_DATATYPE_NUMERIC;}return self::C_DATATYPE_TEXT;}public function addColumn($table,$column,$type){$column=$this->check($column);$table=$this->check($table);$type=$this->typeno_sqltype[$type];$this->adapter->exec("ALTER TABLE `$table` ADD `$column` $type ");}public function code($typedescription,$includeSpecials=FALSE){$r=((isset($this->sqltype_typeno[$typedescription]))?$this->sqltype_typeno[$typedescription]:99);return$r;}public function widenColumn($type,$column,$datatype){$t=$this->getTable($type);$t['columns'][$column]=$this->typeno_sqltype[$datatype];$this->putTable($t);}public function getTables(){return$this->adapter->getCol("SELECT name FROM sqlite_master
			WHERE type='table' AND name!='sqlite_sequence';");}public function createTable($table){$table=$this->esc($table);$sql="CREATE TABLE $table ( id INTEGER PRIMARY KEY AUTOINCREMENT ) ";$this->adapter->exec($sql);}public function getColumns($table){$table=$this->esc($table,TRUE);$columnsRaw=$this->adapter->get("PRAGMA table_info('$table')");$columns=array();foreach($columnsRaw as$r)$columns[$r['name']]=$r['type'];return$columns;}public function addUniqueIndex($type,$columns){$name='UQ_'.$this->esc($type,TRUE).implode('__',$columns);$t=$this->getTable($type);if(isset($t['indexes'][$name]))return;$t['indexes'][$name]=array('name'=>$name);$this->putTable($t);}public function sqlStateIn($state,$list){$stateMap=array('HY000'=>QueryWriter::C_SQLSTATE_NO_SUCH_TABLE,'23000'=>QueryWriter::C_SQLSTATE_INTEGRITY_CONSTRAINT_VIOLATION);return in_array((isset($stateMap[$state])?$stateMap[$state]:'0'),$list);}public function addIndex($type,$name,$column){$table=$type;$table=$this->esc($table);$name=preg_replace('/\W/','',$name);$column=$this->esc($column,TRUE);try{foreach($this->adapter->get("PRAGMA INDEX_LIST($table) ")as$ind){if($ind['name']===$name)return;}$t=$this->getTable($type);$t['indexes'][$name]=array('name'=>$column);$this->putTable($t);}catch(\Exception $exception){}}public function wipe($type){$table=$this->esc($type);$this->adapter->exec("DELETE FROM $table ");}public function addFK($type,$targetType,$field,$targetField,$isDep=FALSE){return$this->buildFK($type,$targetType,$field,$targetField,$isDep);}public function wipeAll(){$this->adapter->exec('PRAGMA foreign_keys = 0 ');foreach($this->getTables()as$t){try{$this->adapter->exec("DROP TABLE IF EXISTS `$t`");}catch(\Exception $e){}try{$this->adapter->exec("DROP TABLE IF EXISTS `$t`");}catch(\Exception $e){}}$this->adapter->exec('PRAGMA foreign_keys = 1 ');}}}namespace RedBeanPHP\QueryWriter{use RedBeanPHP\QueryWriter\AQueryWriter as AQueryWriter;use RedBeanPHP\QueryWriter as QueryWriter;use RedBeanPHP\Adapter\DBAdapter as DBAdapter;use RedBeanPHP\Adapter as Adapter;class PostgreSQL extends AQueryWriter implements QueryWriter{const C_DATATYPE_INTEGER=0;const C_DATATYPE_DOUBLE=1;const C_DATATYPE_TEXT=3;const C_DATATYPE_SPECIAL_DATE=80;const C_DATATYPE_SPECIAL_DATETIME=81;const C_DATATYPE_SPECIAL_POINT=90;const C_DATATYPE_SPECIAL_LSEG=91;const C_DATATYPE_SPECIAL_CIRCLE=92;const C_DATATYPE_SPECIAL_MONEY=93;const C_DATATYPE_SPECIFIED=99;protected$adapter;protected$quoteCharacter='"';protected$defaultValue='DEFAULT';protected function getInsertSuffix($table){return'RETURNING id ';}protected function constrain($table,$table1,$table2,$property1,$property2){try{$adapter=$this->adapter;$fkCode='fk'.md5($table.$property1.$property2);$sql="SELECT c.oid, n.nspname, c.relname,
				n2.nspname, c2.relname, cons.conname
				FROM pg_class c
				JOIN pg_namespace n ON n.oid = c.relnamespace
				LEFT OUTER JOIN pg_constraint cons ON cons.conrelid = c.oid
				LEFT OUTER JOIN pg_class c2 ON cons.confrelid = c2.oid
				LEFT OUTER JOIN pg_namespace n2 ON n2.oid = c2.relnamespace
				WHERE c.relkind = 'r'
					AND n.nspname IN ('public')
					AND (cons.contype = 'f' OR cons.contype IS NULL)
					AND (  cons.conname = '{$fkCode}a'	OR  cons.conname = '{$fkCode}b' )
			";$rows=$adapter->get($sql);if(!count($rows)){$sql1="ALTER TABLE \"$table\" ADD CONSTRAINT
					{$fkCode}a FOREIGN KEY ($property1)
					REFERENCES \"$table1\" (id) ON DELETE CASCADE ON UPDATE CASCADE ";$sql2="ALTER TABLE \"$table\" ADD CONSTRAINT
					{$fkCode}b FOREIGN KEY ($property2)
					REFERENCES \"$table2\" (id) ON DELETE CASCADE ON UPDATE CASCADE ";$adapter->exec($sql1);$adapter->exec($sql2);return TRUE;}return FALSE;}catch(\Exception $e){return FALSE;}}public function __construct(Adapter $adapter){$this->typeno_sqltype=array(self::C_DATATYPE_INTEGER=>' integer ',self::C_DATATYPE_DOUBLE=>' double precision ',self::C_DATATYPE_TEXT=>' text ',self::C_DATATYPE_SPECIAL_DATE=>' date ',self::C_DATATYPE_SPECIAL_DATETIME=>' timestamp without time zone ',self::C_DATATYPE_SPECIAL_POINT=>' point ',self::C_DATATYPE_SPECIAL_LSEG=>' lseg ',self::C_DATATYPE_SPECIAL_CIRCLE=>' circle ',self::C_DATATYPE_SPECIAL_MONEY=>' money ',);$this->sqltype_typeno=array();foreach($this->typeno_sqltype as$k=>$v){$this->sqltype_typeno[trim(strtolower($v))]=$k;}$this->adapter=$adapter;}public function getTypeForID(){return self::C_DATATYPE_INTEGER;}public function getTables(){return$this->adapter->getCol("SELECT table_name FROM information_schema.tables WHERE table_schema = 'public'");}public function createTable($table){$table=$this->esc($table);$this->adapter->exec(" CREATE TABLE $table (id SERIAL PRIMARY KEY); ");}public function getColumns($table){$table=$this->esc($table,TRUE);$columnsRaw=$this->adapter->get("SELECT column_name, data_type FROM information_schema.columns WHERE table_name='$table'");$columns=array();foreach($columnsRaw as$r){$columns[$r['column_name']]=$r['data_type'];}return$columns;}public function scanType($value,$flagSpecial=FALSE){$this->svalue=$value;if($flagSpecial&&$value){if(preg_match('/^\d{4}\-\d\d-\d\d$/',$value)){return PostgreSQL::C_DATATYPE_SPECIAL_DATE;}if(preg_match('/^\d{4}\-\d\d-\d\d\s\d\d:\d\d:\d\d(\.\d{1,6})?$/',$value)){return PostgreSQL::C_DATATYPE_SPECIAL_DATETIME;}if(preg_match('/^\([\d\.]+,[\d\.]+\)$/',$value)){return PostgreSQL::C_DATATYPE_SPECIAL_POINT;}if(preg_match('/^\[\([\d\.]+,[\d\.]+\),\([\d\.]+,[\d\.]+\)\]$/',$value)){return PostgreSQL::C_DATATYPE_SPECIAL_LSEG;}if(preg_match('/^\<\([\d\.]+,[\d\.]+\),[\d\.]+\>$/',$value)){return PostgreSQL::C_DATATYPE_SPECIAL_CIRCLE;}if(preg_match('/^\-?\$[\d,\.]+$/',$value)){return PostgreSQL::C_DATATYPE_SPECIAL_MONEY;}}$sz=($this->startsWithZeros($value));if($sz){return self::C_DATATYPE_TEXT;}if($value===NULL||($value instanceof NULL)||(is_numeric($value)&&floor($value)==$value&&$value<2147483648&&$value>-2147483648)){return self::C_DATATYPE_INTEGER;}elseif(is_numeric($value)){return self::C_DATATYPE_DOUBLE;}else{return self::C_DATATYPE_TEXT;}}public function code($typedescription,$includeSpecials=FALSE){$r=(isset($this->sqltype_typeno[$typedescription]))?$this->sqltype_typeno[$typedescription]:99;if($includeSpecials)return$r;if($r>=QueryWriter::C_DATATYPE_RANGE_SPECIAL){return self::C_DATATYPE_SPECIFIED;}return$r;}public function widenColumn($type,$column,$datatype){$table=$type;$type=$datatype;$table=$this->esc($table);$column=$this->esc($column);$newtype=$this->typeno_sqltype[$type];$this->adapter->exec("ALTER TABLE $table \n\t ALTER COLUMN $column TYPE $newtype ");}public function addUniqueIndex($table,$columns){$table=$this->esc($table,TRUE);sort($columns);foreach($columns as$k=>$v){$columns[$k]=$this->esc($v);}$r=$this->adapter->get("SELECT i.relname AS index_name
			FROM pg_class t,pg_class i,pg_index ix,pg_attribute a
			WHERE t.oid = ix.indrelid
				AND i.oid = ix.indexrelid
				AND a.attrelid = t.oid
				AND a.attnum = ANY(ix.indkey)
				AND t.relkind = 'r'
				AND t.relname = '$table'
			ORDER BY t.relname, i.relname;");$name="UQ_".sha1($table.implode(',',$columns));if($r){foreach($r as$i){if(strtolower($i['index_name'])==strtolower($name)){return;}}}$sql="ALTER TABLE \"$table\"
                ADD CONSTRAINT $name UNIQUE (".implode(',',$columns).")";$this->adapter->exec($sql);}public function sqlStateIn($state,$list){$stateMap=array('42P01'=>QueryWriter::C_SQLSTATE_NO_SUCH_TABLE,'42703'=>QueryWriter::C_SQLSTATE_NO_SUCH_COLUMN,'23505'=>QueryWriter::C_SQLSTATE_INTEGRITY_CONSTRAINT_VIOLATION);return in_array((isset($stateMap[$state])?$stateMap[$state]:'0'),$list);}public function addIndex($type,$name,$column){$table=$type;$table=$this->esc($table);$name=preg_replace('/\W/','',$name);$column=$this->esc($column);if($this->adapter->getCell("SELECT COUNT(*) FROM pg_class WHERE relname = '$name'")){return;}try{$this->adapter->exec("CREATE INDEX $name ON $table ($column) ");}catch(\Exception $e){}}public function addFK($type,$targetType,$field,$targetField,$isDep=FALSE){$db=$this->adapter->getCell('SELECT current_database()');$cfks=$this->adapter->getCell('
			SELECT constraint_name
				FROM information_schema.KEY_COLUMN_USAGE
			WHERE 
				table_catalog = ?
				AND table_schema = \'public\' 
				AND table_name = ? 
				AND column_name = ?
		',array($db,$type,$field));try{if(!$cfks){$delRule=($isDep?'CASCADE':'SET NULL');$this->adapter->exec("ALTER TABLE  {$this->esc($type)}
					ADD FOREIGN KEY ( {$this->esc($field)} ) REFERENCES  {$this->esc($targetType)} (
					{$this->esc($targetField)}) ON DELETE $delRule ON UPDATE $delRule DEFERRABLE ;");}}catch(\Exception $e){return FALSE;}}public function wipeAll(){$this->adapter->exec('SET CONSTRAINTS ALL DEFERRED');foreach($this->getTables()as$t){$t=$this->esc($t);$this->adapter->exec("DROP TABLE IF EXISTS $t CASCADE ");}$this->adapter->exec('SET CONSTRAINTS ALL IMMEDIATE');}}}namespace RedBeanPHP{class RedException extends\Exception{}}namespace RedBeanPHP\RedException{use RedBeanPHP\RedException as RedException;class SQL extends RedException{private$sqlState;public function getSQLState(){return$this->sqlState;}public function setSQLState($sqlState){$this->sqlState=$sqlState;}public function __toString(){return'['.$this->getSQLState().'] - '.$this->getMessage()."\n".'trace: '.$this->getTraceAsString();}}}namespace RedBeanPHP{use RedBeanPHP\OODBBean as OODBBean;use RedBeanPHP\Observable as Observable;use RedBeanPHP\Adapter\DBAdapter as DBAdapter;use RedBeanPHP\BeanHelper\FacadeBeanHelper as FacadeBeanHelper;use RedBeanPHP\AssociationManager as AssociationManager;use RedBeanPHP\QueryWriter as QueryWriter;use RedBeanPHP\RedException\Security as Security;use RedBeanPHP\SimpleModel as SimpleModel;use RedBeanPHP\BeanHelper as BeanHelper;use RedBeanPHP\RedException\SQL as SQL;use RedBeanPHP\QueryWriter\AQueryWriter as AQueryWriter;class OODB extends Observable{protected$chillList=array();protected$stash=NULL;protected$nesting=0;protected$writer;protected$isFrozen=FALSE;protected$beanhelper=NULL;protected$assocManager=NULL;private function handleException(\Exception $exception){if($this->isFrozen||!$this->writer->sqlStateIn($exception->getSQLState(),array(QueryWriter::C_SQLSTATE_NO_SUCH_TABLE,QueryWriter::C_SQLSTATE_NO_SUCH_COLUMN))){throw $exception;}}private function unboxIfNeeded($bean){if($bean instanceof SimpleModel){$bean=$bean->unbox();}if(!($bean instanceof OODBBean)){throw new RedException('OODB Store requires a bean, got: '.gettype($bean));}return$bean;}private function processGroups($originals,$current,$additions,$trashcan,$residue){return array(array_merge($additions,array_diff($current,$originals)),array_merge($trashcan,array_diff($originals,$current)),array_merge($residue,array_intersect($current,$originals)));}private function getTypeFromCast($cast){if($cast=='string'){$typeno=$this->writer->scanType('STRING');}elseif($cast=='id'){$typeno=$this->writer->getTypeForID();}elseif(isset($this->writer->sqltype_typeno[$cast])){$typeno=$this->writer->sqltype_typeno[$cast];}else{throw new RedException('Invalid Cast');}return$typeno;}private function prepareEmbeddedBean($embeddedBean){if(!$embeddedBean->id||$embeddedBean->getMeta('tainted')){$this->store($embeddedBean);}return$embeddedBean->id;}private function createTableIfNotExists(OODBBean $bean,$table){if(!$this->isFrozen&&!$this->tableExists($this->writer->esc($table,TRUE))){$this->writer->createTable($table);$bean->setMeta('buildreport.flags.created',TRUE);}}private function addUniqueConstraints(OODBBean $bean){if($uniques=$bean->getMeta('buildcommand.unique')){$table=$bean->getMeta('type');foreach($uniques as$unique){if(!$this->isChilled($table))$this->writer->addUniqueIndex($table,$unique);}}}private function storeBean(OODBBean $bean){if($bean->getMeta('tainted')){if(!$this->isFrozen){$this->check($bean);$table=$bean->getMeta('type');$this->createTableIfNotExists($bean,$table);$updateValues=$this->getUpdateValues($bean);$this->addUniqueConstraints($bean);$bean->id=$this->writer->updateRecord($table,$updateValues,$bean->id);$bean->setMeta('tainted',FALSE);}else{list($properties,$table)=$bean->getPropertiesAndType();$id=$properties['id'];unset($properties['id']);$updateValues=array();$k1='property';$k2='value';foreach($properties as$key=>$value){$updateValues[]=array($k1=>$key,$k2=>$value);}$bean->id=$this->writer->updateRecord($table,$updateValues,$id);$bean->setMeta('tainted',FALSE);}}}private function getUpdateValues(OODBBean $bean){$updateValues=array();foreach($bean as$property=>$value){if(!$this->isFrozen&&$property!=='id'){$this->moldTable($bean,$property,$value);}if($property!=='id'){$updateValues[]=array('property'=>$property,'value'=>$value);}}return$updateValues;}private function moldTable(OODBBean $bean,$property,$value){$table=$bean->getMeta('type');$columns=$this->writer->getColumns($table);if(!in_array($bean->getMeta('type'),$this->chillList)){if($bean->getMeta("cast.$property",-1)!==-1){$cast=$bean->getMeta("cast.$property");$typeno=$this->getTypeFromCast($cast);}else{$cast=FALSE;$typeno=$this->writer->scanType($value,TRUE);}if(isset($columns[$this->writer->esc($property,TRUE)])){if(!$cast){$typeno=$this->writer->scanType($value,FALSE);}$sqlt=$this->writer->code($columns[$this->writer->esc($property,TRUE)]);if($typeno>$sqlt){$this->writer->widenColumn($table,$property,$typeno);$bean->setMeta('buildreport.flags.widen',TRUE);}}else{$this->writer->addColumn($table,$property,$typeno);$bean->setMeta('buildreport.flags.addcolumn',TRUE);$this->processBuildCommands($table,$property,$bean);}}}private function processSharedAdditions($bean,$sharedAdditions){foreach($sharedAdditions as$addition){if($addition instanceof OODBBean){$this->assocManager->associate($addition,$bean);}else{throw new RedException('Array may only contain OODBBeans');}}}private function processResidue($ownresidue){foreach($ownresidue as$residue){if($residue->getMeta('tainted')){$this->store($residue);}}}private function processTrashcan($bean,$ownTrashcan){foreach($ownTrashcan as$trash){$myFieldLink=$bean->getMeta('type').'_id';$alias=$bean->getMeta('sys.alias.'.$trash->getMeta('type'));if($alias)$myFieldLink=$alias.'_id';if($trash->getMeta('sys.garbage')===true){$this->trash($trash);}else{$trash->$myFieldLink=NULL;$this->store($trash);}}}private function processSharedTrashcan($bean,$sharedTrashcan){foreach($sharedTrashcan as$trash){$this->assocManager->unassociate($trash,$bean);}}private function processSharedResidue($bean,$sharedresidue){foreach($sharedresidue as$residue){$this->store($residue);}}private function addForeignKeysForParentBeans($bean,$embeddedBeans){$cachedIndex=array();foreach($embeddedBeans as$linkField=>$embeddedBean){$beanType=$bean->getMeta('type');$embeddedType=$embeddedBean->getMeta('type');$key=$beanType.'|'.$embeddedType.'>'.$linkField;if(!isset($cachedIndex[$key])){$this->writer->addIndex($bean->getMeta('type'),'index_foreignkey_'.$beanType.'_'.$embeddedType,$linkField);$this->writer->addFK($beanType,$embeddedType,$linkField,'id',FALSE);$cachedIndex[$key]=TRUE;}}}private function processAdditions($bean,$ownAdditions){$beanType=$bean->getMeta('type');$cachedIndex=array();foreach($ownAdditions as$addition){if($addition instanceof OODBBean){$myFieldLink=$beanType.'_id';$alias=$bean->getMeta('sys.alias.'.$addition->getMeta('type'));if($alias)$myFieldLink=$alias.'_id';$addition->$myFieldLink=$bean->id;$addition->setMeta('cast.'.$myFieldLink,'id');$this->store($addition);if(!$this->isFrozen){$additionType=$addition->getMeta('type');$key=$additionType.'|'.$beanType.'>'.$myFieldLink;if(!isset($cachedIndex[$key])){$this->writer->addIndex($additionType,'index_foreignkey_'.$additionType.'_'.$beanType,$myFieldLink);$isDep=$bean->getMeta('sys.exclusive-'.$additionType);$this->writer->addFK($additionType,$beanType,$myFieldLink,'id',$isDep);$cachedIndex[$key]=TRUE;}}}else{throw new RedException('Array may only contain OODBBeans');}}}private function hasListsOrObjects(OODBBean $bean){$processLists=FALSE;foreach($bean as$value){if(is_array($value)||is_object($value)){$processLists=TRUE;break;}}return$processLists;}private function processBuildCommands($table,$property,OODBBean $bean){if($inx=($bean->getMeta('buildcommand.indexes'))){if(isset($inx[$property])){$this->writer->addIndex($table,$inx[$property],$property);}}}private function processEmbeddedBean(&$embeddedBeans,$bean,$property,OODBBean $value){$linkField=$property.'_id';$bean->$linkField=$this->prepareEmbeddedBean($value);$bean->setMeta('cast.'.$linkField,'id');$embeddedBeans[$linkField]=$value;unset($bean->$property);}private function processLists(OODBBean $bean){$sharedAdditions=$sharedTrashcan=$sharedresidue=$sharedItems=$ownAdditions=$ownTrashcan=$ownresidue=$embeddedBeans=array();foreach($bean as$property=>$value){$value=($value instanceof SimpleModel)?$value->unbox():$value;if($value instanceof OODBBean){$this->processEmbeddedBean($embeddedBeans,$bean,$property,$value);}elseif(is_array($value)){$originals=$bean->getMeta('sys.shadow.'.$property,array());$bean->setMeta('sys.shadow.'.$property,NULL);if(strpos($property,'own')===0){list($ownAdditions,$ownTrashcan,$ownresidue)=$this->processGroups($originals,$value,$ownAdditions,$ownTrashcan,$ownresidue);$listName=lcfirst(substr($property,3));if($bean->getMeta('sys.exclusive-'.$listName)){OODBBean::setMetaAll($ownTrashcan,'sys.garbage',TRUE);}unset($bean->$property);}elseif(strpos($property,'shared')===0){list($sharedAdditions,$sharedTrashcan,$sharedresidue)=$this->processGroups($originals,$value,$sharedAdditions,$sharedTrashcan,$sharedresidue);unset($bean->$property);}}}$this->storeBean($bean);if(!$this->isFrozen){$this->addForeignKeysForParentBeans($bean,$embeddedBeans);}$this->processTrashcan($bean,$ownTrashcan);$this->processAdditions($bean,$ownAdditions);$this->processResidue($ownresidue);$this->processSharedTrashcan($bean,$sharedTrashcan);$this->processSharedAdditions($bean,$sharedAdditions);$this->processSharedResidue($bean,$sharedresidue);}public function __construct(QueryWriter $writer){if($writer instanceof QueryWriter){$this->writer=$writer;}}public function freeze($toggle){if(is_array($toggle)){$this->chillList=$toggle;$this->isFrozen=FALSE;}else{$this->isFrozen=(boolean)$toggle;}}public function isFrozen(){return(bool)$this->isFrozen;}public function isChilled($type){return(boolean)(in_array($type,$this->chillList));}public function dispense($type,$number=1,$alwaysReturnArray=FALSE){if($number<1){if($alwaysReturnArray)return array();return NULL;}$beans=array();for($i=0;$i<$number;$i++){$bean=new OODBBean;$bean->initializeForDispense($type,$this->beanhelper);if(!$this->isFrozen){$this->check($bean);}$this->signal('dispense',$bean);$beans[]=$bean;}return(count($beans)===1&&!$alwaysReturnArray)?array_pop($beans):$beans;}public function setBeanHelper(BeanHelper $beanhelper){$this->beanhelper=$beanhelper;}public function check(OODBBean $bean){if(!isset($bean->id)){throw new RedException('Bean has incomplete Meta Information id ');}if(!($bean->getMeta('type'))){throw new RedException('Bean has incomplete Meta Information II');}$pattern='/[^a-z0-9_]/i';if(preg_match($pattern,$bean->getMeta('type'))){throw new RedException('Bean Type is invalid');}foreach($bean as$prop=>$value){if(is_array($value)||(is_object($value))){throw new RedException("Invalid Bean value: property $prop");}elseif(strlen($prop)<1||preg_match($pattern,$prop)){throw new RedException("Invalid Bean property: property $prop");}}}public function find($type,$conditions=array(),$sql=NULL,$bindings=array()){if(is_array($sql)){if(isset($sql[1])){$bindings=$sql[1];}$sql=$sql[0];}try{$beans=$this->convertToBeans($type,$this->writer->queryRecord($type,$conditions,$sql,$bindings));return$beans;}catch(SQL $exception){$this->handleException($exception);}return array();}public function tableExists($table){return$this->writer->tableExists($table);}public function store($bean){$bean=$this->unboxIfNeeded($bean);$processLists=$this->hasListsOrObjects($bean);if(!$processLists&&!$bean->getMeta('tainted')){return$bean->getID();}$this->signal('update',$bean);$processLists=$this->hasListsOrObjects($bean);if($processLists){$this->processLists($bean);}else{$this->storeBean($bean);}$this->signal('after_update',$bean);return((string)$bean->id===(string)(int)$bean->id)?(int)$bean->id:(string)$bean->id;}public function load($type,$id){$bean=$this->dispense($type);if(isset($this->stash[$this->nesting][$id])){$row=$this->stash[$this->nesting][$id];}else{try{$rows=$this->writer->queryRecord($type,array('id'=>array($id)));}catch(SQL $exception){if($this->writer->sqlStateIn($exception->getSQLState(),array(QueryWriter::C_SQLSTATE_NO_SUCH_COLUMN,QueryWriter::C_SQLSTATE_NO_SUCH_TABLE))){$rows=0;if($this->isFrozen){throw $exception;}}}if(empty($rows)){return$bean;}$row=array_pop($rows);}$bean->importRow($row);$this->nesting++;$this->signal('open',$bean);$this->nesting--;return$bean->setMeta('tainted',FALSE);}public function trash($bean){if($bean instanceof SimpleModel){$bean=$bean->unbox();}if(!($bean instanceof OODBBean)){throw new RedException('OODB Store requires a bean, got: '.gettype($bean));}$this->signal('delete',$bean);foreach($bean as$property=>$value){if($value instanceof OODBBean){unset($bean->$property);}if(is_array($value)){if(strpos($property,'own')===0){unset($bean->$property);}elseif(strpos($property,'shared')===0){unset($bean->$property);}}}if(!$this->isFrozen){$this->check($bean);}try{$this->writer->deleteRecord($bean->getMeta('type'),array('id'=>array($bean->id)),NULL);}catch(SQL $exception){$this->handleException($exception);}$bean->id=0;$this->signal('after_delete',$bean);}public function batch($type,$ids){if(!$ids){return array();}$collection=array();try{$rows=$this->writer->queryRecord($type,array('id'=>$ids));}catch(SQL $e){$this->handleException($e);$rows=FALSE;}$this->stash[$this->nesting]=array();if(!$rows){return array();}foreach($rows as$row){$this->stash[$this->nesting][$row['id']]=$row;}foreach($ids as$id){$collection[$id]=$this->load($type,$id);}$this->stash[$this->nesting]=NULL;return$collection;}public function convertToBeans($type,$rows){$collection=array();$this->stash[$this->nesting]=array();foreach($rows as$row){$id=$row['id'];$this->stash[$this->nesting][$id]=$row;$collection[$id]=$this->load($type,$id);}$this->stash[$this->nesting]=NULL;return$collection;}public function count($type,$addSQL='',$bindings=array()){$type=AQueryWriter::camelsSnake($type);if(count(explode('_',$type))>2){throw new RedException('Invalid type for count.');}try{return(int)$this->writer->queryRecordCount($type,array(),$addSQL,$bindings);}catch(SQL $exception){if(!$this->writer->sqlStateIn($exception->getSQLState(),array(QueryWriter::C_SQLSTATE_NO_SUCH_TABLE,QueryWriter::C_SQLSTATE_NO_SUCH_COLUMN))){throw $exception;}}return0;}public function wipe($type){try{$this->writer->wipe($type);return TRUE;}catch(SQL $exception){if(!$this->writer->sqlStateIn($exception->getSQLState(),array(QueryWriter::C_SQLSTATE_NO_SUCH_TABLE))){throw $exception;}return FALSE;}}public function getAssociationManager(){if(!isset($this->assocManager)){throw new RedException('No association manager available.');}return$this->assocManager;}public function setAssociationManager(AssociationManager $assocManager){$this->assocManager=$assocManager;}}}namespace RedBeanPHP{use RedBeanPHP\OODB as OODB;use RedBeanPHP\QueryWriter as QueryWriter;use RedBeanPHP\Adapter\DBAdapter as DBAdapter;use RedBeanPHP\Adapter as Adapter;class ToolBox{protected$oodb;protected$writer;protected$adapter;public function __construct(OODB $oodb,Adapter $adapter,QueryWriter $writer){$this->oodb=$oodb;$this->adapter=$adapter;$this->writer=$writer;return$this;}public function getWriter(){return$this->writer;}public function getRedBean(){return$this->oodb;}public function getDatabaseAdapter(){return$this->adapter;}}}namespace RedBeanPHP{use RedBeanPHP\ToolBox as ToolBox;use RedBeanPHP\OODB as OODB;use RedBeanPHP\RedException\Security as Security;use RedBeanPHP\OODBBean as OODBBean;class Finder{protected$toolbox;protected$redbean;public function __construct(ToolBox $toolbox){$this->toolbox=$toolbox;$this->redbean=$toolbox->getRedBean();}public function find($type,$sql=NULL,$bindings=array()){if(!is_array($bindings)){throw new RedException('Expected array, '.gettype($bindings).' given.');}return$this->redbean->find($type,array(),$sql,$bindings);}public function findAndExport($type,$sql=NULL,$bindings=array()){$arr=array();foreach($this->find($type,$sql,$bindings)as$key=>$item){$arr[]=$item->export();}return$arr;}public function findOne($type,$sql=NULL,$bindings=array()){$items=$this->find($type,$sql,$bindings);if(empty($items)){return NULL;}return reset($items);}public function findLast($type,$sql=NULL,$bindings=array()){$items=$this->find($type,$sql,$bindings);if(empty($items)){return NULL;}return end($items);}public function findOrDispense($type,$sql=NULL,$bindings=array()){$foundBeans=$this->find($type,$sql,$bindings);if(empty($foundBeans)){return array($this->redbean->dispense($type));}else{return$foundBeans;}}}}namespace RedBeanPHP{use RedBeanPHP\Observable as Observable;use RedBeanPHP\OODB as OODB;use RedBeanPHP\Adapter\DBAdapter as DBAdapter;use RedBeanPHP\QueryWriter as QueryWriter;use RedBeanPHP\OODBBean as OODBBean;use RedBeanPHP\RedException as RedException;use RedBeanPHP\RedException\Security as Security;use RedBeanPHP\RedException\SQL as SQL;use RedBeanPHP\ToolBox as ToolBox;class AssociationManager extends Observable{protected$oodb;protected$adapter;protected$writer;private function handleException(\Exception $exception){if($this->oodb->isFrozen()||!$this->writer->sqlStateIn($exception->getSQLState(),array(QueryWriter::C_SQLSTATE_NO_SUCH_TABLE,QueryWriter::C_SQLSTATE_NO_SUCH_COLUMN))){throw $exception;}}private function relatedRows($bean,$type,$sql='',$bindings=array()){$ids=array($bean->id);$sourceType=$bean->getMeta('type');try{return$this->writer->queryRecordRelated($sourceType,$type,$ids,$sql,$bindings);}catch(SQL $exception){$this->handleException($exception);return array();}}protected function associateBeans(OODBBean $bean1,OODBBean $bean2,OODBBean $bean){$property1=$bean1->getMeta('type').'_id';$property2=$bean2->getMeta('type').'_id';if($property1==$property2){$property2=$bean2->getMeta('type').'2_id';}$unique=array($property1,$property2);$type=$bean->getMeta('type');$tables=$this->writer->getTables();if(in_array($type,$tables)&&!$this->oodb->isChilled($type)){$columns=($this->writer->getColumns($type));if(count($columns)===3&&isset($columns['id'])&&isset($columns[$property1])&&isset($columns[$property2])){$bean->setMeta('buildcommand.unique',array($unique));}}$indexName1='index_for_'.$bean->getMeta('type').'_'.$property1;$indexName2='index_for_'.$bean->getMeta('type').'_'.$property2;$bean->setMeta('buildcommand.indexes',array($property1=>$indexName1,$property2=>$indexName2));$this->oodb->store($bean1);$this->oodb->store($bean2);$bean->setMeta("cast.$property1","id");$bean->setMeta("cast.$property2","id");$bean->$property1=$bean1->id;$bean->$property2=$bean2->id;$results=array();try{$id=$this->oodb->store($bean);if(!$this->oodb->isFrozen()&&$bean->getMeta('buildreport.flags.created')){$bean->setMeta('buildreport.flags.created',0);if(!$this->oodb->isFrozen()){$this->writer->addConstraintForTypes($bean1->getMeta('type'),$bean2->getMeta('type'));}}$results[]=$id;}catch(SQL $exception){if(!$this->writer->sqlStateIn($exception->getSQLState(),array(QueryWriter::C_SQLSTATE_INTEGRITY_CONSTRAINT_VIOLATION))){throw $exception;}}return$results;}public function __construct(ToolBox $tools){$this->oodb=$tools->getRedBean();$this->adapter=$tools->getDatabaseAdapter();$this->writer=$tools->getWriter();$this->toolbox=$tools;}public function getTable($types){return$this->writer->getAssocTable($types);}public function associate($beans1,$beans2){if(!is_array($beans1)){$beans1=array($beans1);}if(!is_array($beans2)){$beans2=array($beans2);}$results=array();foreach($beans1 as$bean1){foreach($beans2 as$bean2){$table=$this->getTable(array($bean1->getMeta('type'),$bean2->getMeta('type')));$bean=$this->oodb->dispense($table);$results[]=$this->associateBeans($bean1,$bean2,$bean);}}return(count($results)>1)?$results:reset($results);}public function relatedCount($bean,$type,$sql=NULL,$bindings=array()){if(!($bean instanceof OODBBean)){throw new RedException('Expected array or OODBBean but got:'.gettype($bean));}if(!$bean->id){return0;}$beanType=$bean->getMeta('type');try{return$this->writer->queryRecordCountRelated($beanType,$type,$bean->id,$sql,$bindings);}catch(SQL $exception){$this->handleException($exception);return0;}}public function unassociate($beans1,$beans2,$fast=NULL){$beans1=(!is_array($beans1))?array($beans1):$beans1;$beans2=(!is_array($beans2))?array($beans2):$beans2;foreach($beans1 as$bean1){foreach($beans2 as$bean2){try{$this->oodb->store($bean1);$this->oodb->store($bean2);$type1=$bean1->getMeta('type');$type2=$bean2->getMeta('type');$row=$this->writer->queryRecordLink($type1,$type2,$bean1->id,$bean2->id);$linkType=$this->getTable(array($type1,$type2));if($fast){$this->writer->deleteRecord($linkType,array('id'=>$row['id']));return;}$beans=$this->oodb->convertToBeans($linkType,array($row));if(count($beans)>0){$bean=reset($beans);$this->oodb->trash($bean);}}catch(SQL $exception){$this->handleException($exception);}}}}public function clearRelations(OODBBean $bean,$type){$this->oodb->store($bean);try{$this->writer->deleteRelations($bean->getMeta('type'),$type,$bean->id);}catch(SQL $exception){$this->handleException($exception);}}public function related($bean,$type,$sql='',$bindings=array()){$sql=$this->writer->glueSQLCondition($sql);$rows=$this->relatedRows($bean,$type,$sql,$bindings);$links=array();foreach($rows as$key=>$row){if(!isset($links[$row['id']])){$links[$row['id']]=array();}$links[$row['id']][]=$row['linked_by'];unset($rows[$key]['linked_by']);}$beans=$this->oodb->convertToBeans($type,$rows);foreach($beans as$bean){$bean->setMeta('sys.belongs-to',$links[$bean->id]);}return$beans;}}}namespace RedBeanPHP{use RedBeanPHP\ToolBox as ToolBox;use RedBeanPHP\OODBBean as OODBBean;interface BeanHelper{public function getToolbox();public function getExtractedToolbox();public function getModelForBean(OODBBean $bean);}}namespace RedBeanPHP\BeanHelper{use RedBeanPHP\BeanHelper as BeanHelper;use RedBeanPHP\Facade as Facade;use RedBeanPHP\OODBBean as OODBBean;use RedBeanPHP\SimpleModelHelper as SimpleModelHelper;class SimpleFacadeBeanHelper implements BeanHelper{private static$factory=null;public function getToolbox(){return Facade::getToolBox();}public function getModelForBean(OODBBean $bean){$model=$bean->getMeta('type');$prefix=defined('REDBEAN_MODEL_PREFIX')?REDBEAN_MODEL_PREFIX:'\\Model_';if(strpos($model,'_')!==FALSE){$modelParts=explode('_',$model);$modelName='';foreach($modelParts as$part){$modelName.=ucfirst($part);}$modelName=$prefix.$modelName;if(!class_exists($modelName)){$modelName=$prefix.ucfirst($model);if(!class_exists($modelName)){return NULL;}}}else{$modelName=$prefix.ucfirst($model);if(!class_exists($modelName)){return NULL;}}$obj=self::factory($modelName);$obj->loadBean($bean);return$obj;}public function getExtractedToolbox(){return Facade::getExtractedToolbox();}public static function factory($modelClassName){$factory=self::$factory;return($factory)?$factory($modelClassName):new $modelClassName();}public static function setFactoryFunction($factory){self::$factory=$factory;}}}namespace RedBeanPHP{use RedBeanPHP\OODBBean as OODBBean;class SimpleModel{protected$bean;public function loadBean(OODBBean $bean){$this->bean=$bean;}public function __get($prop){return$this->bean->$prop;}public function __set($prop,$value){$this->bean->$prop=$value;}public function __isset($key){return isset($this->bean->$key);}public function box(){return$this;}public function unbox(){return$this->bean;}}}namespace RedBeanPHP{use RedBeanPHP\Observer as Observer;use RedBeanPHP\OODBBean as OODBBean;use RedBeanPHP\Observable as Observable;class SimpleModelHelper implements Observer{public function onEvent($eventName,$bean){$bean->$eventName();}public function attachEventListeners(Observable $observable){foreach(array('update','open','delete','after_delete','after_update','dispense')as$e){$observable->addEventListener($e,$this);}}}}namespace RedBeanPHP{use RedBeanPHP\ToolBox as ToolBox;use RedBeanPHP\AssociationManager as AssociationManager;use RedBeanPHP\OODBBean as OODBBean;class TagManager{protected$toolbox;protected$associationManager;protected$redbean;private function extractTagsIfNeeded($tagList){if($tagList!==FALSE&&!is_array($tagList)){$tags=explode(',',(string)$tagList);}else{$tags=$tagList;}return$tags;}public function __construct(ToolBox $toolbox){$this->toolbox=$toolbox;$this->redbean=$toolbox->getRedBean();$this->associationManager=$this->redbean->getAssociationManager();}protected function findTagByTitle($title){$beans=$this->redbean->find('tag',array('title'=>array($title)));if($beans){$bean=reset($beans);return$bean;}return NULL;}public function hasTag($bean,$tags,$all=FALSE){$foundtags=$this->tag($bean);$tags=$this->extractTagsIfNeeded($tags);$same=array_intersect($tags,$foundtags);if($all){return(implode(',',$same)===implode(',',$tags));}return(bool)(count($same)>0);}public function untag($bean,$tagList){$tags=$this->extractTagsIfNeeded($tagList);foreach($tags as$tag){if($t=$this->findTagByTitle($tag)){$this->associationManager->unassociate($bean,$t);}}}public function tag(OODBBean $bean,$tagList=NULL){if(is_null($tagList)){$tags=$bean->sharedTag;$foundTags=array();foreach($tags as$tag){$foundTags[]=$tag->title;}return$foundTags;}$this->associationManager->clearRelations($bean,'tag');$this->addTags($bean,$tagList);return$tagList;}public function addTags(OODBBean $bean,$tagList){$tags=$this->extractTagsIfNeeded($tagList);if($tagList===FALSE){return;}foreach($tags as$tag){if(!$t=$this->findTagByTitle($tag)){$t=$this->redbean->dispense('tag');$t->title=$tag;$this->redbean->store($t);}$this->associationManager->associate($bean,$t);}}public function tagged($beanType,$tagList){$tags=$this->extractTagsIfNeeded($tagList);$collection=array();$tags=$this->redbean->find('tag',array('title'=>$tags));$list='shared'.ucfirst($beanType);if(is_array($tags)&&count($tags)>0){foreach($tags as$tag){$collection+=$tag->$list;}}return$collection;}public function taggedAll($beanType,$tagList){$tags=$this->extractTagsIfNeeded($tagList);$beans=array();foreach($tags as$tag){$beans=$this->tagged($beanType,$tag);if(isset($oldBeans)){$beans=array_intersect_assoc($beans,$oldBeans);}$oldBeans=$beans;}return$beans;}}}namespace RedBeanPHP{use RedBeanPHP\ToolBox as ToolBox;use RedBeanPHP\OODBBean as OODBBean;class LabelMaker{protected$toolbox;public function __construct(ToolBox $toolbox){$this->toolbox=$toolbox;}public function dispenseLabels($type,$labels){$labelBeans=array();foreach($labels as$label){$labelBean=$this->toolbox->getRedBean()->dispense($type);$labelBean->name=$label;$labelBeans[]=$labelBean;}return$labelBeans;}public function gatherLabels($beans){$labels=array();foreach($beans as$bean){$labels[]=$bean->name;}sort($labels);return$labels;}public function enum($enum){$oodb=$this->toolbox->getRedBean();if(strpos($enum,':')===FALSE){$type=$enum;$value=FALSE;}else{list($type,$value)=explode(':',$enum);$value=preg_replace('/\W+/','_',strtoupper(trim($value)));}$values=$oodb->find($type);if($value===FALSE){return$values;}foreach($values as$enumItem){if($enumItem->name===$value)return$enumItem;}$newEnumItems=$this->dispenseLabels($type,array($value));$newEnumItem=reset($newEnumItems);$oodb->store($newEnumItem);return$newEnumItem;}}}namespace RedBeanPHP{use RedBeanPHP\ToolBox as ToolBox;use RedBeanPHP\OODB as OODB;use RedBeanPHP\QueryWriter as QueryWriter;use RedBeanPHP\Adapter\DBAdapter as DBAdapter;use RedBeanPHP\AssociationManager as AssociationManager;use RedBeanPHP\TagManager as TagManager;use RedBeanPHP\DuplicationManager as DuplicationManager;use RedBeanPHP\LabelMaker as LabelMaker;use RedBeanPHP\Finder as Finder;use RedBeanPHP\RedException\SQL as SQL;use RedBeanPHP\RedException\Security as Security;use RedBeanPHP\Logger as Logger;use RedBeanPHP\Logger\RDefault as RDefault;use RedBeanPHP\OODBBean as OODBBean;use RedBeanPHP\SimpleModel as SimpleModel;use RedBeanPHP\SimpleModelHelper as SimpleModelHelper;use RedBeanPHP\Adapter as Adapter;use RedBeanPHP\QueryWriter\AQueryWriter as AQueryWriter;use RedBeanPHP\RedException as RedException;use RedBeanPHP\BeanHelper\SimpleFacadeBeanHelper as SimpleFacadeBeanHelper;use RedBeanPHP\Driver\RPDO as RPDO;class Facade{const C_REDBEANPHP_VERSION='4.0';private static$toolboxes=array();private static$toolbox;private static$redbean;private static$writer;private static$adapter;private static$associationManager;private static$tagManager;private static$duplicationManager;private static$labelMaker;private static$finder;private static$currentDB='';private static$plugins=array();private static function query($method,$sql,$bindings){if(!self::$redbean->isFrozen()){try{$rs=Facade::$adapter->$method($sql,$bindings);}catch(SQL $exception){if(self::$writer->sqlStateIn($exception->getSQLState(),array(QueryWriter::C_SQLSTATE_NO_SUCH_COLUMN,QueryWriter::C_SQLSTATE_NO_SUCH_TABLE))){return($method==='getCell')?NULL:array();}else{throw $exception;}}return$rs;}else{return Facade::$adapter->$method($sql,$bindings);}}public static function getVersion(){return self::C_REDBEANPHP_VERSION;}public static function setup($dsn=NULL,$username=NULL,$password=NULL,$frozen=FALSE){if(is_null($dsn)){$dsn='sqlite:/'.sys_get_temp_dir().'/red.db';}self::addDatabase('default',$dsn,$username,$password,$frozen);self::selectDatabase('default');return self::$toolbox;}public static function transaction($callback){if(!is_callable($callback)){throw new RedException('R::transaction needs a valid callback.');}static$depth=0;$result=null;try{if($depth==0){self::begin();}$depth++;$result=call_user_func($callback);$depth--;if($depth==0){self::commit();}}catch(\Exception $exception){$depth--;if($depth==0){self::rollback();}throw $exception;}return$result;}public static function addDatabase($key,$dsn,$user=NULL,$pass=NULL,$frozen=FALSE){if(isset(self::$toolboxes[$key])){throw new RedException('A database has already be specified for this key.');}if(is_object($dsn)){$db=new RPDO($dsn);$dbType=$db->getDatabaseType();}else{$db=new RPDO($dsn,$user,$pass,TRUE);$dbType=substr($dsn,0,strpos($dsn,':'));}$adapter=new DBAdapter($db);$writers=array('pgsql'=>'PostgreSQL','sqlite'=>'SQLiteT','cubrid'=>'CUBRID','mysql'=>'MySQL');$wkey=trim(strtolower($dbType));if(!isset($writers[$wkey]))trigger_error('Unsupported DSN: '.$wkey);$writerClass='\\RedBeanPHP\\QueryWriter\\'.$writers[$wkey];$writer=new $writerClass($adapter);$redbean=new OODB($writer);$redbean->freeze(($frozen===TRUE));self::$toolboxes[$key]=new ToolBox($redbean,$adapter,$writer);}public static function selectDatabase($key){if(self::$currentDB===$key){return FALSE;}self::configureFacadeWithToolbox(self::$toolboxes[$key]);self::$currentDB=$key;return TRUE;}public static function debug($tf=TRUE,$mode=0){$logger=new RDefault;if(!isset(self::$adapter)){throw new RedException('Use R::setup() first.');}$logger->setMode($mode);self::$adapter->getDatabase()->setDebugMode($tf,$logger);return$logger;}public static function inspect($type=NULL){return($type===NULL)?self::$writer->getTables():self::$writer->getColumns($type);}public static function store($bean){return self::$redbean->store($bean);}public static function freeze($tf=TRUE){self::$redbean->freeze($tf);}public static function loadMulti($types,$id){if(is_string($types)){$types=explode(',',$types);}if(!is_array($types)){return array();}foreach($types as$k=>$typeItem){$types[$k]=self::$redbean->load($typeItem,$id);}return$types;}public static function load($type,$id){return self::$redbean->load($type,$id);}public static function trash($bean){self::$redbean->trash($bean);}public static function dispense($typeOrBeanArray,$num=1,$alwaysReturnArray=FALSE){if(is_array($typeOrBeanArray)){if(!isset($typeOrBeanArray['_type']))throw new RedException('Missing _type field.');$import=$typeOrBeanArray;$type=$import['_type'];unset($import['_type']);}else{$type=$typeOrBeanArray;}if(!preg_match('/^[a-z0-9]+$/',$type)){throw new RedException('Invalid type: '.$type);}$beanOrBeans=self::$redbean->dispense($type,$num,$alwaysReturnArray);if(isset($import)){$beanOrBeans->import($import);}return$beanOrBeans;}public static function dispenseAll($order,$onlyArrays=FALSE){$list=array();foreach(explode(',',$order)as$order){if(strpos($order,'*')!==false){list($type,$amount)=explode('*',$order);}else{$type=$order;$amount=1;}$list[]=self::dispense($type,$amount,$onlyArrays);}return$list;}public static function findOrDispense($type,$sql=NULL,$bindings=array()){return self::$finder->findOrDispense($type,$sql,$bindings);}public static function find($type,$sql=NULL,$bindings=array()){return self::$finder->find($type,$sql,$bindings);}public static function findAll($type,$sql=NULL,$bindings=array()){return self::$finder->find($type,$sql,$bindings);}public static function findAndExport($type,$sql=NULL,$bindings=array()){return self::$finder->findAndExport($type,$sql,$bindings);}public static function findOne($type,$sql=NULL,$bindings=array()){return self::$finder->findOne($type,$sql,$bindings);}public static function findLast($type,$sql=NULL,$bindings=array()){return self::$finder->findLast($type,$sql,$bindings);}public static function batch($type,$ids){return self::$redbean->batch($type,$ids);}public static function loadAll($type,$ids){return self::$redbean->batch($type,$ids);}public static function exec($sql,$bindings=array()){return self::query('exec',$sql,$bindings);}public static function getAll($sql,$bindings=array()){return self::query('get',$sql,$bindings);}public static function getCell($sql,$bindings=array()){return self::query('getCell',$sql,$bindings);}public static function getRow($sql,$bindings=array()){return self::query('getRow',$sql,$bindings);}public static function getCol($sql,$bindings=array()){return self::query('getCol',$sql,$bindings);}public static function getAssoc($sql,$bindings=array()){return self::query('getAssoc',$sql,$bindings);}public static function getAssocRow($sql,$bindings=array()){return self::query('getAssocRow',$sql,$bindings);}public static function dup($bean,$trail=array(),$pid=FALSE,$filters=array()){self::$duplicationManager->setFilters($filters);return self::$duplicationManager->dup($bean,$trail,$pid);}public static function exportAll($beans,$parents=FALSE,$filters=array()){return self::$duplicationManager->exportAll($beans,$parents,$filters);}public static function convertToBeans($type,$rows){return self::$redbean->convertToBeans($type,$rows);}public static function hasTag($bean,$tags,$all=FALSE){return self::$tagManager->hasTag($bean,$tags,$all);}public static function untag($bean,$tagList){self::$tagManager->untag($bean,$tagList);}public static function tag(OODBBean $bean,$tagList=NULL){return self::$tagManager->tag($bean,$tagList);}public static function addTags(OODBBean $bean,$tagList){self::$tagManager->addTags($bean,$tagList);}public static function tagged($beanType,$tagList){return self::$tagManager->tagged($beanType,$tagList);}public static function taggedAll($beanType,$tagList){return self::$tagManager->taggedAll($beanType,$tagList);}public static function wipe($beanType){return Facade::$redbean->wipe($beanType);}public static function count($type,$addSQL='',$bindings=array()){return Facade::$redbean->count($type,$addSQL,$bindings);}public static function configureFacadeWithToolbox(ToolBox $tb){$oldTools=self::$toolbox;self::$toolbox=$tb;self::$writer=self::$toolbox->getWriter();self::$adapter=self::$toolbox->getDatabaseAdapter();self::$redbean=self::$toolbox->getRedBean();self::$finder=new Finder(self::$toolbox);self::$associationManager=new AssociationManager(self::$toolbox);self::$redbean->setAssociationManager(self::$associationManager);self::$labelMaker=new LabelMaker(self::$toolbox);$helper=new SimpleModelHelper();$helper->attachEventListeners(self::$redbean);self::$redbean->setBeanHelper(new SimpleFacadeBeanHelper);self::$associationManager->addEventListener('delete',$helper);self::$duplicationManager=new DuplicationManager(self::$toolbox);self::$tagManager=new TagManager(self::$toolbox);return$oldTools;}public static function begin(){if(!self::$redbean->isFrozen())return FALSE;self::$adapter->startTransaction();return TRUE;}public static function commit(){if(!self::$redbean->isFrozen())return FALSE;self::$adapter->commit();return TRUE;}public static function rollback(){if(!self::$redbean->isFrozen())return FALSE;self::$adapter->rollback();return TRUE;}public static function getColumns($table){return self::$writer->getColumns($table);}public static function genSlots($array){return(count($array))?implode(',',array_fill(0,count($array),'?')):'';}public static function nuke(){if(!self::$redbean->isFrozen()){self::$writer->wipeAll();}}public static function storeAll($beans){$ids=array();foreach($beans as$bean){$ids[]=self::store($bean);}return$ids;}public static function trashAll($beans){foreach($beans as$bean){self::trash($bean);}}public static function useWriterCache($yesNo){self::getWriter()->setUseCache($yesNo);}public static function dispenseLabels($type,$labels){return self::$labelMaker->dispenseLabels($type,$labels);}public static function enum($enum){return self::$labelMaker->enum($enum);}public static function gatherLabels($beans){return self::$labelMaker->gatherLabels($beans);}public static function close(){if(isset(self::$adapter)){self::$adapter->close();}}public static function isoDate($time=NULL){if(!$time){$time=time();}return@date('Y-m-d',$time);}public static function isoDateTime($time=NULL){if(!$time)$time=time();return@date('Y-m-d H:i:s',$time);}public static function setDatabaseAdapter(Adapter $adapter){self::$adapter=$adapter;}public static function setWriter(QueryWriter $writer){self::$writer=$writer;}public static function setRedBean(OODB $redbean){self::$redbean=$redbean;}public static function getDatabaseAdapter(){return self::$adapter;}public static function getDuplicationManager(){return self::$duplicationManager;}public static function getWriter(){return self::$writer;}public static function getRedBean(){return self::$redbean;}public static function getToolBox(){return self::$toolbox;}public static function getExtractedToolbox(){return array(self::$redbean,self::$adapter,self::$writer,self::$toolbox);}public static function renameAssociation($from,$to=NULL){AQueryWriter::renameAssociation($from,$to);}public static function beansToArray($beans){$list=array();foreach($beans as$bean){$list[]=$bean->export();}return$list;}public static function ext($pluginName,$callable){if(!ctype_alnum($pluginName)){throw new RedException('Plugin name may only contain alphanumeric characters.');}self::$plugins[$pluginName]=$callable;}public static function __callStatic($pluginName,$params){if(!ctype_alnum($pluginName)){throw new RedException('Plugin name may only contain alphanumeric characters.');}if(!isset(self::$plugins[$pluginName])){throw new RedException('Plugin \''.$pluginName.'\' does not exist, add this plugin using: R::ext(\''.$pluginName.'\')');}return call_user_func_array(self::$plugins[$pluginName],$params);}}}namespace RedBeanPHP{use RedBeanPHP\ToolBox as ToolBox;use RedBeanPHP\AssociationManager as AssociationManager;use RedBeanPHP\OODB as OODB;use RedBeanPHP\OODBBean as OODBBean;use RedBeanPHP\QueryWriter\AQueryWriter as AQueryWriter;class DuplicationManager{protected$toolbox;protected$associationManager;protected$redbean;protected$tables=array();protected$columns=array();protected$filters=array();protected$cacheTables=FALSE;private function copySharedBeans(OODBBean $copy,$shared,$beans){$copy->$shared=array();foreach($beans as$subBean){array_push($copy->$shared,$subBean);}}private function copyOwnBeans(OODBBean $copy,$owned,$beans,$trail,$preserveIDs){$copy->$owned=array();foreach($beans as$subBean){array_push($copy->$owned,$this->duplicate($subBean,$trail,$preserveIDs));}}private function createCopy(OODBBean $bean){$type=$bean->getMeta('type');$copy=$this->redbean->dispense($type);$copy->importFrom($bean);$copy->id=0;return$copy;}private function inTrailOrAdd(&$trail,OODBBean $bean){$type=$bean->getMeta('type');$key=$type.$bean->getID();if(isset($trail[$key])){return TRUE;}$trail[$key]=$bean;return FALSE;}private function getListNames($typeName){$owned='own'.ucfirst($typeName);$shared='shared'.ucfirst($typeName);return array($owned,$shared);}protected function hasOwnList($type,$target){return isset($this->columns[$target][$type.'_id']);}protected function hasSharedList($type,$target){return in_array(AQueryWriter::getAssocTableFormat(array($type,$target)),$this->tables);}protected function duplicate(OODBBean $bean,$trail=array(),$preserveIDs=FALSE){if($this->inTrailOrAdd($trail,$bean))return$bean;$type=$bean->getMeta('type');$copy=$this->createCopy($bean);foreach($this->tables as$table){if(!empty($this->filters)){if(!in_array($table,$this->filters))continue;}list($owned,$shared)=$this->getListNames($table);if($this->hasSharedList($type,$table)){if($beans=$bean->$shared){$this->copySharedBeans($copy,$shared,$beans);}}elseif($this->hasOwnList($type,$table)){if($beans=$bean->$owned){$this->copyOwnBeans($copy,$owned,$beans,$trail,$preserveIDs);}$copy->setMeta('sys.shadow.'.$owned,NULL);}$copy->setMeta('sys.shadow.'.$shared,NULL);}$copy->id=($preserveIDs)?$bean->id:$copy->id;return$copy;}public function __construct(ToolBox $toolbox){$this->toolbox=$toolbox;$this->redbean=$toolbox->getRedBean();$this->associationManager=$this->redbean->getAssociationManager();}public function setTables($tables){foreach($tables as$key=>$value){if(is_numeric($key)){$this->tables[]=$value;}else{$this->tables[]=$key;$this->columns[$key]=$value;}}$this->cacheTables=TRUE;}public function getSchema(){return$this->columns;}public function setCacheTables($yesNo){$this->cacheTables=$yesNo;}public function setFilters($filters){if(!is_array($filters)){$filters=array($filters);}$this->filters=$filters;}public function dup(OODBBean $bean,$trail=array(),$preserveIDs=FALSE){if(!count($this->tables)){$this->tables=$this->toolbox->getWriter()->getTables();}if(!count($this->columns)){foreach($this->tables as$table){$this->columns[$table]=$this->toolbox->getWriter()->getColumns($table);}}$rs=$this->duplicate(clone($bean),$trail,$preserveIDs);if(!$this->cacheTables){$this->tables=array();$this->columns=array();}return$this->duplicate($rs,$trail,$preserveIDs);}public function exportAll($beans,$parents=FALSE,$filters=array()){$array=array();if(!is_array($beans)){$beans=array($beans);}foreach($beans as$bean){$this->setFilters($filters);$duplicate=$this->dup($bean,array(),TRUE);$array[]=$duplicate->export(FALSE,$parents,FALSE,$filters);}return$array;}}}namespace RedBeanPHP{interface Plugin{};}namespace{class RedBean_SimpleModel extends\RedBeanPHP\SimpleModel{};if(!class_exists('R')){class R extends\RedBeanPHP\Facade{};}if(!function_exists('EID')){function EID($enumName){return\RedBeanPHP\Facade::enum($enumName)->id;}}}?>