<?php class clqdynrss extends clq{public$db=array(),$feed_url,$indent,$channel,$channel_xml,$item,$item_xml;private$feed_data;function __construct(){$this->item=array();$this->channel=array();$this->indent='    ';$url=parse_url(preg_match('/^https/i',$_SERVER['SCRIPT_URI'])?'https':'http'."://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]");$url="$url[scheme]://$url[host]$url[path]";if(strlen($url['query'])>1)$url.="?{$url[query]}";$this->feed_url=$url;}public function db($host,$name,$user,$pass,$type='mysql'){$this->db['host']=$host;$this->db['name']=$name;$this->db['user']=$user;$this->db['pass']=$pass;$this->db['type']=$type;return$this;}public function query($query){$this->db['query']=$query;return$this;}public function feed_url($feed_url){$this->feed_url=$feed_url;return$this;}public function indent($indent){$this->indent=(string)$indent;return$this;}public function channel($channel=array()){foreach($channel as$key=>$value)$this->channel[$key]=$value;return$this;}public function channel_xml($channel_xml){$this->channel_xml=$channel_xml;return$this;}public function image($url,$width=null,$height=null){$width=$width>144?88:intval($width);$height=$height>400?31:intval($height);$this->channel['image']['url']=$url;$this->channel['image']['title']=$this->channel['title'];$this->channel['image']['link']=$this->channel['link'];$this->channel['image']['width']=$width;$this->channel['image']['height']=$height;return$this;}public function item($item=array()){foreach($item as$key=>$value)$this->item[$key]=$value;return$this;}public function item_xml($item_xml){$this->item_xml=$item_xml;return$this;}public function generate($output='screen'){$this->generate_rss();switch($output){case'string':return$this->feed_data;break;case'screen':header("Content-Type: application/rss+xml");echo $this->feed_data;return$this;break;default:exit('Invalid output mode');break;}}private function xmlentities($string){return htmlentities($string);}private function generate_rss(){$this->feed_data="<?xml version = \"1.0\"?>\n";$this->feed_data.="<rss version=\"2.0\" xmlns:atom=\"http://www.w3.org/2005/Atom\">\n";$this->feed_data.="$this->indent<channel>\n";$this->feed_data.="$this->indent$this->indent<atom:link href=\"".$this->feed_url."\" rel=\"self\" type=\"application/rss+xml\" />\n";foreach($this->channel as$key=>$value){if(!is_array($this->channel[$key])){$this->feed_data.="$this->indent$this->indent<$key>".$this->xmlentities($value)."</$key>\n";}else{$this->feed_data.="$this->indent$this->indent<$key>\n";foreach($this->channel[$key]as$subkey=>$subvalue)$this->feed_data.="$this->indent$this->indent$this->indent<$subkey>".$this->xmlentities($subvalue)."</$subkey>\n";$this->feed_data.="$this->indent$this->indent</$key>\n";}}if(!empty($this->channel_xml))$this->feed_data.="$this->indent$this->indent$this->channel_xml";$d=@mysql_connect($this->db['host'],$this->db['user'],$this->db['pass']);if(!$d)exit('Unable to establish a MySQL connection');if(!@mysql_select_db($this->db['name'],$d))exit('Unable to connect to database');$item=mysql_query($this->db['query']);if(!$item)exit('Failed to execute query');while($row=mysql_fetch_array($item)){$this->feed_data.="$this->indent$this->indent<item>\n";foreach($this->item as$key=>$value){preg_match_all('/\{([A-Za-z0-9-_]+)\}/',$row[$key],$m);for($i=0;$i<count($m);$i++)$row[$key]=preg_replace('/\{\{([A-Za-z0-9-_]+)\}\}/',$row[$m[1][$i]],$row[$key]);$this->feed_data.="$this->indent$this->indent$this->indent<$key>".$this->xmlentities($row[$value])."</$key>\n";}if(!empty($this->item_xml)){preg_match_all('/\{([A-Za-z0-9-_]+)\}/',$this->item_xml,$m);for($i=0;$i<count($m);$i++)$this->item_xml=preg_replace('/\{\{([A-Za-z0-9-_]+)\}\}/',$row[$m[1][$i]],$this->item_xml);$this->feed_data.="$this->indent$this->indent$this->indent$this->item_xml\n";}$this->feed_data.="$this->indent$this->indent</item>\n";}$this->feed_data.="$this->indent</channel>\n";$this->feed_data.="</rss>";return$this;}}?>